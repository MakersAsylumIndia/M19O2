Ibles.package("Ibles.mixins"),Ibles.mixins.SelectOneCollection={getSelected:function(){return this.findWhere({selected:!0})},select:function(e){this.forEach(function(e){e.set({selected:!1},{silent:!0})}),e.set({selected:!0})},deselect:function(e){e.set({selected:!1})}},Ibles.mixins.SelectManyCollection={getSelected:function(){return this.where({selected:!0})},select:function(e){e.set({selected:!0})},deselect:function(e){e.set({selected:!1})},deselectAll:function(){this.invoke("set",{selected:!1})},selectOnly:function(t,n){this.deselectAll(),this.forEach(function(e){_.contains(n,e.get(t))&&e.set({selected:!0})})}},Ibles.mixins.SelectableModel={mergedAttributes:{selected:!1},select:function(e){return this.collection.select(this,e),this},deselect:function(e){return this.collection.deselect(this,e),this},toggleSelected:function(e){return this.get("selected")?this.deselect(e):this.select(e),this}},Ibles.package("Ibles.models"),Ibles.models.ChannelModel=Backbone.Model.extend({idAttribute:"name",defaults:{name:null,title:null,type:null,category:null,following:!1},toggleFollowing:function(){var t=this,e=_.extend(this.getFollowedParams(),{following:!this.get("following")});return Ibles.API.post({url:Ibles.apiUrl("setFollowing"),data:$.param(e,!0),processData:!1,success:function(e){t.set({following:e.following})}})},getFollowedParams:function(){var e={};return Ibles.setFollowChannelParams(e,this.get("category"),this.get("name")),e},isFollowing:function(){var t=this,e=this.getFollowedParams();return Ibles.API.getRequest("isFollowing",e,{success:function(e){t.set({following:e.isFollowing})}})}}),Ibles.package("Ibles.collections"),Ibles.collections.ChannelCollection=Backbone.Collection.extend({initialize:function(){this.makeMultiSelectable()},makeMultiSelectable:function(){Ibles.applyMixin(this,Ibles.mixins.SelectManyCollection)},model:function(e,t){return Ibles.makeModelSelectable(new Ibles.models.ChannelModel(e,t))},modelId:function(e){return e.name},getChannel:function(e){return this.get(e)}}),Ibles.package("Ibles.models"),Ibles.models.CategoryModel=Backbone.Model.extend({idAttribute:"name",defaults:function(){return{name:null,title:null,type:null,channels:[]}},initialize:function(e){var t=e||{};this.channelsCollection=new Ibles.collections.ChannelCollection(t.channels||[],{parse:!0})},getDisplayTitle:function(){return this.get("title")}}),Ibles.package("Ibles.models"),Ibles.models.TeacherCategoryModel=Ibles.models.CategoryModel.fullExtend({defaults:function(){return{name:null,title:null,type:null,channels:[],grades:[],gradeGroups:[],subjects:[]}},initialize:function(e,t){var n=e||{},i=n.grades||[],s=n.gradeGroups||[],o=n.subjects||[],a=i.concat(o);this._super(_.extend(n,{channels:a}),t),this.gradesCollection=new Ibles.collections.GradeCollection(i,{parse:!0}),this.gradeGroupsCollection=new Ibles.collections.GradeGroupCollection(s,{parse:!0}),this.subjectsCollection=new Ibles.collections.SubjectCollection(o,{parse:!0})},reset:function(e){var t=e||{};this.gradesCollection.reset(t.grades||[]),this.gradeGroupsCollection.reset(t.gradeGroups||[]),this.subjectsCollection.reset(t.subjects||[]),this.channelsCollection.reset((t.grades||[]).concat(t.subjects||[])),this.set({name:t.name,title:t.title,type:t.type})}}),Ibles.package("Ibles.collections"),Ibles.collections.CategoryCollection=Backbone.Collection.extend({initialize:function(){Ibles.applyMixin(this,Ibles.mixins.SelectOneCollection)},model:function(e,t){var n="teachers"===e.name?new Ibles.models.TeacherCategoryModel(e,t):new Ibles.models.CategoryModel(e,t);return Ibles.applyMixin(n,Ibles.mixins.SelectableModel),n},modelId:function(e){return e.name},getCategoryModel:function(e){return this.get(e)},getChannelsInCategory:function(e){var t=this.getCategoryModel(e);return t&&t.channelsCollection}}),Ibles.package("Ibles.models"),Ibles.models.SubjectModel=Ibles.models.ChannelModel.fullExtend({defaults:function(){return{type:"subject",category:"teachers"}}}),Ibles.package("Ibles.collections"),Ibles.collections.SubjectCollection=Ibles.collections.ChannelCollection.extend({model:function(e,t){return Ibles.makeModelSelectable(new Ibles.models.SubjectModel(e,t))},getSelectedSubjectNames:function(){var e=this.getSelected();return _.map(e,function(e){return e.get("name")})},getSelectedSubjectTitles:function(){var e=this.getSelected();return _.map(e,function(e){return e.get("title")})}}),Ibles.package("Ibles.models"),Ibles.models.GradeModel=Ibles.models.ChannelModel.fullExtend({defaults:function(){return{type:"grade",category:"teachers",gradeGroup:null}}}),Ibles.package("Ibles.collections"),Ibles.collections.GradeCollection=Ibles.collections.ChannelCollection.extend({model:function(e,t){return Ibles.makeModelSelectable(new Ibles.models.GradeModel(e,t))},getSelectedGradeGroupNames:function(){var e=this.getSelected(),t=_.map(e,function(e){return e.get("gradeGroup")});return _.uniq(t)}}),Ibles.package("Ibles.models"),Ibles.models.GradeGroupModel=Ibles.models.ChannelModel.fullExtend({defaults:function(){return{name:"",title:"",type:"gradeGroup",category:"teachers",grades:[]}},getFollowedParams:function(){return{grade:this.get("grades")}}}),Ibles.package("Ibles.collections"),Ibles.collections.GradeGroupCollection=Ibles.collections.ChannelCollection.extend({model:function(e,t){return Ibles.makeModelSelectable(new Ibles.models.GradeGroupModel(e,t))},initialize:function(e){var t,n,i;this._super(e),e||(t=Ibles.pageContext.gradeGroups,_.isEmpty(t)||this.reset(Ibles.pageContext.gradeGroups),i=(n=Ibles.pageContext.taxonomy)&&_.findWhere(n,{name:"teachers"}),_.isEmpty(i)||_.isEmpty(i.gradeGroups)||this.reset(i.gradeGroups))},getGradeGroupContainingGrade:function(t){return this.find(function(e){return _.contains(e.get("grades"),t)})},getSelectedNames:function(){return _.map(this.getSelected(),function(e){return e.get("title")})},getSelectedGrades:function(){var t=[];return _.each(this.getSelected(),function(e){t=t.concat(e.get("grades"))}),t}}),Ibles.package("Ibles.models"),Ibles.models.Taxonomy=Backbone.Model.fullExtend({initialize:function(){this.categoryCollection=new Ibles.collections.CategoryCollection(Ibles.pageContext.taxonomy||[]),this.originalData=[]},clone:function(){var e=new Ibles.models.Taxonomy;return e.categoryCollection.reset(this.originalData,{parse:!0}),e},fetch:function(){var t=this;return this.fetchPromise().done(function(e){t.originalData=e,t.categoryCollection.reset(e,{parse:!0}),t.trigger("taxonomyLoaded")})},fetchPromise:function(){return Ibles.taxonomyPromise||(Ibles.taxonomyPromise=Ibles.API.get({url:Ibles.reverseUrls.getTaxonomyUrl()})),Ibles.taxonomyPromise},getChannelsInCategory:function(e){return this.categoryCollection.getChannelsInCategory(e)},getChannelInCategory:function(e,t){var n=this.getChannelsInCategory(e);return n&&n.getChannel(t)},hasChannelInCategory:function(e,t){return!!this.getChannelInCategory(e,t)},getCategory:function(e){return this.categoryCollection.get(e)},getTeachersCategory:function(){return this.categoryCollection.get("teachers")},getSubjectsCollection:function(){return this.getTeachersCategory().subjectsCollection},getSubject:function(e){return this.getSubjectsCollection().get(e)},getGradesCollection:function(){return this.getTeachersCategory().gradesCollection},getGrade:function(e){return this.getGradesCollection().get(e)},getGradeGroupForGrade:function(t){return this.getTeachersCategory().gradeGroupsCollection.find(function(e){return _.contains(e.get("grades"),t)})},toFlatBrowsableChannelsList:function(){var t=[];return this.categoryCollection.each(function(e){"teachers"===e.get("name")?(t.push.apply(t,e.get("gradeGroups")),t.push.apply(t,_.filter(e.get("channels"),function(e){return"subject"===e.type}))):t.push.apply(t,e.get("channels"))}),t}}),Ibles.package("Ibles.models"),Ibles.models.Classifier=Backbone.Model.extend({defaults:{classifiable:null,updatePrimary:!0},save:function(){var e=this,t=this.getParams(e.get("classifiable"));return this.trigger("status",{name:"loading"}),Ibles.API.jsonPostRequest("setClassifications",t).done(function(){e.trigger("status",{name:"success"})}).fail(function(){e.trigger("status",{name:"error"})})},getParams:function(e){var t=this.get("updatePrimary"),n={id:e.get("id"),type:this.getTypeParam(e)};return Ibles.setClassificationsPostParam(e,n,t),n},getTypeParam:function(e){var t=e.get("type");return"Guide"==t?"collection":"Step by Step"==t?"project":"topic"}}),Ibles.package("Ibles.models","Ibles.collections"),Ibles.models.MemberModel=Backbone.Model.extend({defaults:function(){return{id:null,screenName:null,downloadUrl:null,following:!1,views:0,commentCount:0,discussionCount:0,featuredCount:0,favoritesCount:0,instructablesCount:0,draftsCount:0,publishedCollectionsCount:0,draftCollectionsCount:0,collaborationsCount:0,followersCount:0,subscriptionsCount:0,draftCourses:[],occupations:[],images:[]}},initialize:function(e,t){t=t||{},this.userDataFetched=!1,this.profileImageCollection=new Ibles.collections.FileCollection(this.get("images")),t.fetchAuthorStats&&this.fetchAuthorStats(),t.fetchUserData&&this.fetchUserData()},getUrl:function(){return Ibles.reverseUrls.memberUrl(this.get("screenName"))},getAvatarFile:function(){return Ibles.fileFromDict(this.attributes)},getProfileImageUrls:function(){return this.profileImageCollection.map(function(e){return e.getMediumUrl()})},fetch:function(){var t=this;return Ibles.API.getRequest("showAuthorModel",{screenName:this.get("screenName")}).done(function(e){t.set(e)})},fetchAuthorStats:function(){var t=this;Ibles.API.getRequest("showAuthorStats",{screenName:this.get("screenName")}).done(function(e){t.set(e)}).always(function(){t.trigger("authorStatsSynced")})},fetchUserData:function(){var t=this;Ibles.session.authenticated()&&(Ibles.session.isAdmin()||Ibles.session.get("screenName")===this.get("screenName"))&&Ibles.API.getRequest("showAuthorUserData",{screenName:this.get("screenName"),cb:Date.now()}).done(function(e){t.set(e),t.profileImageCollection.reset(e.images||[])}).always(function(){t.trigger("userDataSynced"),t.userDataFetched=!0})},toggleFollowing:function(){var t=this;return Ibles.API.postRequest("setFollowing",{memberId:this.get("id"),following:!this.get("following")},{success:function(e){t.set({following:e.following})}})},isFollowing:function(){var t=this;return Ibles.API.getRequest("isFollowing",{screenName:this.get("screenName"),cb:Date.now()},{success:function(e){t.set({following:e.isFollowing||!1})}})},purgeFromCache:function(){return Ibles.API.jsonPostRequest("purgeCaches",{ids:[this.get("id")]})},sendPrivateMessage:function(e,t,n){var i={posted:(new Date).getTime(),body:Ibles.paragraphize(t.replace(/<\/?[^>]+(>|$)/g,"")),subject:e.replace(/<\/?[^>]+(>|$)/g,""),recipientId:this.get("id")},s=this;return _.isEmpty(n)||(i.inReplyToId=n),Ibles.API.baseAjaxPostRequest("/edit/compose/","",i,{success:function(){s.trigger("privateMessageSent")},error:function(){s.trigger("privateMessageError")}})},updateProfile:function(e){var t=this;return Ibles.API.jsonPost(Ibles.URLS.updateProfileUrl(),e).done(function(){Ibles.session.resetForCurrentUser(function(){t.trigger("updateProfileSuccess")})}).fail(function(){t.trigger("updateProfileError")})},updateSettings:function(e){var t=e||{};return Ibles.API.post({url:Ibles.URLS.updateSettingsUrl(),data:t})}}),Ibles.collections.MemberCollection=Backbone.Collection.extend({model:Ibles.models.MemberModel}),Ibles.package("Ibles.models"),Ibles.models.BaseInstructableModel=Backbone.Model.extend({defaults:function(){return{id:null,title:null,urlString:null,fullUrl:null,author:null,type:null,status:null,classifications:[],category:null,channel:null,publishDate:null,favorite:!1,flagged:!1,fetchUserData:!1,fetchStats:!1,resourceType:null,collaborators:[],indexTags:[],submissions:[],coverImage:null}},initialize:function(e){this.author=new Ibles.models.MemberModel(this.get("author")),this.set({favorite:e&&e.favorite}),this.get("fetchUserData")&&this.fetchUserData(),this.get("fetchStats")&&this.fetchStats()},fetch:function(){var t=this;return Ibles.API.getRequest("showInstructableModel",{id:this.get("id")}).done(function(e){t.set(t.parse(e)),e.author&&t.author.set(e.author)})},parse:function(e){return Ibles.setPrimaryClassificationDetails(e),Ibles.deepExtend(Ibles.pageContext.ibleData,e),e},fetchUserData:function(){var t;Ibles.session.authenticated()&&(t=this,Ibles.API.getRequest("showInstructableUserData",{id:this.get("id"),rand:Math.round((new Date).getTime()/1e3)}).done(function(e){"LIMBO"!==e.status||_.isUndefined(e.limboDate)||(e.status="SPAM"),t.set(t.parse(e)),t.author.set({following:e.following})}).always(function(){t.trigger("userDataSynced")}))},fetchStats:function(){var t=this;return Ibles.API.getRequest("getIbleStats",{id:this.get("id")},{success:function(e){t.set(e)}},["views","favorites","comments"])},flagAction:function(){var e=this;return Ibles.API.ajaxRequest("flag/",{entryID:this.get("id"),action:"SET",flag:this.get("flaggedAs")},{success:function(){e.set({flagged:!0})}})},favoriteAction:function(){var e=this;return Ibles.API.ajaxRequest("favorite/",{entryId:this.get("id")},{success:function(){e.set({favorite:!e.get("favorite")})}})},isFavorite:function(){var t=this;return Ibles.API.getRequest("isFavorite",{id:this.get("id")},{success:function(e){t.set({favorite:e.isFavorite})}})},isOwner:function(e){return this.author.get("id")===e},currentUserIsOwner:function(){var e=Ibles.session;return e.authenticated()&&this.isOwner(e.get("id"))},isCollaborator:function(){var e=this.get("collaborators");return!_.isEmpty(e)&&!_.isEmpty(_.findWhere(e,{id:Ibles.session.get("id")}))},isEditableByCurrentUser:function(){var e=Ibles.session,t=e.get("id");return e.isAdmin()||this.isOwner(t)||this.isCollaborator(t)||e.canEditMakeyMakeyResource()||e.canSetIndexTags()||e.canEditKeywords()||e.canEditClassifications()},getNonInternalIndexTags:function(){return _.without(this.get("indexTags")||[],"internal")},toJSON:function(){var e=Backbone.Model.prototype.toJSON.apply(this,arguments);return e.url=Ibles.reverseUrls.ibleUrl(e.id),e},getPdfUrl:function(){return"/json-api/viewPdf?id={0}".format(this.get("id"))},getEditUrl:function(){return"Guide"===this.get("type")?Ibles.reverseUrls.collectionEditUrl(this.get("id")):Ibles.reverseUrls.ibleEditUrl(this.get("id"))},getFiles:function(){var n=$.Deferred();return this.getFilesPromise||("Step by Step"!==this.get("type")?n.resolve([]):Ibles.API.getRequest("getFiles",{instructableId:this.get("id")},{success:function(e){var t=e.files.map(function(e){return new Ibles.collections.FileCollection(e||[])});n.resolve(t)}}),this.getFilesPromise=n.promise()),this.getFilesPromise},getPhotosetFiles:function(){var t=$.Deferred();return this.getFiles().done(function(e){var n=[];_.each(e,function(e){var t;!e.length||(t=e.filter(function(e){return e.get("image")})).length&&n.push(new Ibles.collections.FileCollection(t))}),t.resolve(n)}),t.promise()},getNonImageFileCollection:function(){var n=$.Deferred();return this.getFiles().done(function(e){var t=new Ibles.collections.FileCollection([]);_.each(e,function(e){e.length&&t.add(e.filter(function(e){return!e.get("image")}))}),n.resolve(t)}),n.promise()},fetchPdfAsBinary:function(){var n=this.get("urlString")+".pdf",i=$.Deferred();return window.JSZipUtils.getBinaryContent(this.getPdfUrl(),function(e,t){i.resolve({fileName:n,error:e,data:t})}),i.promise()},fetchAttachmentsAsBinary:function(){var n=$.Deferred();return this.getNonImageFileCollection().done(function(e){var s=[];e.each(function(e){var n=$.Deferred(),t=e.getDownloadUrl(),i=e.get("name");s.push(n),window.JSZipUtils.getBinaryContent(t,function(e,t){n.resolve({fileName:i,error:e,data:t})})}),$.when.apply($,s).always(function(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);n.resolve(e)})}),n.promise()},downloadZipBundle:function(){var s=this,o=$.Deferred();return s.fetchPdfAsBinary().done(function(i){i.error?o.reject(i.error):s.fetchAttachmentsAsBinary().done(function(e){var t=new window.JSZip,n=t.folder(s.get("urlString"));n.file(i.fileName,i.data,{binary:!0}),_.each(e,function(e){e.error||n.file(e.fileName,e.data,{binary:!0})}),t.generateAsync({type:"blob"}).then(function(e){saveAs(e,s.get("urlString")+".zip"),o.resolve()})})}),o.promise()}}),Ibles.package("Ibles.models"),Ibles.models.InstructableModel=Ibles.models.BaseInstructableModel.fullExtend({defaults:function(){return{disableComments:!1,allSteps:!1,currentStepIndex:0}},initialize:function(e,t){this._super(e,t),this.set({fullUrl:Ibles.pageContext.remoteHost+this.getUrl()})},getUrl:function(){var e=Ibles.reverseUrls;return"UNPUBLISHED"===this.get("status")?e.previewUrl(this.get("id")):e.ibleUrl(this.get("urlString")||this.get("id"))}}),Ibles.package("Ibles.collections"),Ibles.collections.InstructableCollection=Backbone.Collection.extend({model:Ibles.models.InstructableModel}),Ibles.package("Ibles.services"),Ibles.services.ImageRotationService=Backbone.Model.extend({rotateFileId:function(e,t){return Ibles.API.put({url:Ibles.apiUrl("file"),data:JSON.stringify({id:e,customRotation:t}),contentType:"application/json"})},rotateFileUrl:function(e,t){var n=e.split("/").pop().replace(/\..*/,"");return this.rotateFileId(n,t)}}),$.browser={version:8,msie:0<window.navigator.userAgent.indexOf("MSIE ")},function(e,t,p){var i=p(e),s=p(t),f=p.fancybox=function(){f.open.apply(this,arguments)},n=!1,o=void 0!==t.createTouch;p.extend(f,{version:"2.0.5",defaults:{padding:15,margin:20,width:800,height:600,minWidth:100,minHeight:100,maxWidth:9999,maxHeight:9999,autoSize:!0,autoResize:!o,autoCenter:!o,fitToView:!0,aspectRatio:!1,topRatio:.5,fixed:!(p.browser.msie&&p.browser.version<=6||o),scrolling:"auto",wrapCSS:"fancybox-default",arrows:!0,closeBtn:!0,closeClick:!1,nextClick:!1,mouseWheel:!0,autoPlay:!1,playSpeed:3e3,preload:3,modal:!1,loop:!0,ajax:{dataType:"html",headers:{"X-fancyBox":!0}},keys:{next:[13,32,34,39,40],prev:[8,33,37,38],close:[27]},tpl:{wrap:'<div class="fancybox-wrap"><div class="fancybox-outer"><div class="fancybox-inner"></div></div></div>',image:'<img class="fancybox-image" src="{href}" alt="" />',iframe:'<iframe class="fancybox-iframe" name="fancybox-frame{rnd}" frameborder="0" hspace="0"'+(p.browser.msie?' allowtransparency="true"':"")+"></iframe>",swf:'<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="100%" height="100%"><param name="wmode" value="transparent" /><param name="allowfullscreen" value="true" /><param name="allowscriptaccess" value="always" /><param name="movie" value="{href}" /><embed src="{href}" type="application/x-shockwave-flash" allowfullscreen="true" allowscriptaccess="always" width="100%" height="100%" wmode="transparent"></embed></object>',error:'<p class="fancybox-error">The requested content cannot be loaded.<br/>Please try again later.</p>',closeBtn:'<div title="Close" class="fancybox-item fancybox-close"></div>',next:'<a title="Next" class="fancybox-nav fancybox-next"><span></span></a>',prev:'<a title="Previous" class="fancybox-nav fancybox-prev"><span></span></a>'},openEffect:"fade",openSpeed:250,openEasing:"swing",openOpacity:!0,openMethod:"zoomIn",closeEffect:"fade",closeSpeed:250,closeEasing:"swing",closeOpacity:!0,closeMethod:"zoomOut",nextEffect:"elastic",nextSpeed:300,nextEasing:"swing",nextMethod:"changeIn",prevEffect:"elastic",prevSpeed:300,prevEasing:"swing",prevMethod:"changeOut",helpers:{overlay:{speedIn:0,speedOut:300,opacity:.8,css:{cursor:"pointer"},closeClick:!0},title:{type:"float"}}},group:{},opts:{},coming:null,current:null,isOpen:!1,isOpened:!1,wrap:null,outer:null,inner:null,player:{timer:null,isActive:!1},ajaxLoad:null,imgPreload:null,transitions:{},helpers:{},open:function(e,t){f.close(!0),e&&!p.isArray(e)&&(e=e instanceof p?p(e).get():[e]),f.isActive=!0,f.opts=p.extend(!0,{},f.defaults,t),p.isPlainObject(t)&&void 0!==t.keys&&(f.opts.keys=!!t.keys&&p.extend({},f.defaults.keys,t.keys)),f.group=e,f._start(f.opts.index||0)},cancel:function(){f.coming&&!1===f.trigger("onCancel")||(f.coming=null,f.hideLoading(),f.ajaxLoad&&f.ajaxLoad.abort(),f.ajaxLoad=null,f.imgPreload&&(f.imgPreload.onload=f.imgPreload.onabort=f.imgPreload.onerror=null))},close:function(e){f.cancel(),f.current&&!1!==f.trigger("beforeClose")&&(f.unbindEvents(),!f.isOpen||e&&!0===e[0]?(p(".fancybox-wrap").stop().trigger("onReset").remove(),f._afterZoomOut()):(f.isOpen=f.isOpened=!1,p(".fancybox-item, .fancybox-nav").remove(),f.wrap.stop(!0).removeClass("fancybox-opened"),f.inner.css("overflow","hidden"),f.transitions[f.current.closeMethod]()))},play:function(e){function t(){clearTimeout(f.player.timer)}function n(){t(),f.current&&f.player.isActive&&(f.player.timer=setTimeout(f.next,f.current.playSpeed))}function i(){t(),p("body").unbind(".player"),f.player.isActive=!1,f.trigger("onPlayEnd")}f.player.isActive||e&&!1===e[0]?i():f.current&&(f.current.loop||f.current.index<f.group.length-1)&&(f.player.isActive=!0,p("body").bind({"afterShow.player onUpdate.player":n,"onCancel.player beforeClose.player":i,"beforeLoad.player":t}),n(),f.trigger("onPlayStart"))},next:function(){f.current&&f.jumpto(f.current.index+1)},prev:function(){f.current&&f.jumpto(f.current.index-1)},jumpto:function(e){f.current&&(e=parseInt(e,10),1<f.group.length&&f.current.loop&&(e>=f.group.length?e=0:e<0&&(e=f.group.length-1)),void 0!==f.group[e]&&(f.cancel(),f._start(e)))},reposition:function(e){f.isOpen&&f.wrap.css(f._getPosition(e))},update:function(t){f.isOpen&&(n||setTimeout(function(){var e=f.current;n&&(n=!1,e)&&((e.autoResize||t&&"orientationchange"===t.type)&&(e.autoSize&&(f.inner.height("auto"),e.height=f.inner.height()),f._setDimension(),e.canGrow&&f.inner.height("auto")),e.autoCenter&&f.reposition(),f.trigger("onUpdate"))},100),n=!0)},toggle:function(){f.isOpen&&(f.current.fitToView=!f.current.fitToView,f.update())},hideLoading:function(){p("#fancybox-loading").remove()},showLoading:function(){f.hideLoading(),p('<div id="fancybox-loading"><div></div></div>').click(f.cancel).appendTo("body")},getViewport:function(){return{x:i.scrollLeft(),y:i.scrollTop(),w:i.width(),h:i.height()}},unbindEvents:function(){f.wrap&&f.wrap.unbind(".fb"),s.unbind(".fb"),i.unbind(".fb")},bindEvents:function(){var e=f.current,n=e.keys;e&&(i.bind("resize.fb, orientationchange.fb",f.update),n&&s.bind("keydown.fb",function(e){var t;e.ctrlKey||e.altKey||e.shiftKey||e.metaKey||!(p.inArray(e.target.tagName.toLowerCase(),["input","textarea","select","button"])<0)||(t=e.keyCode,-1<p.inArray(t,n.close)?(f.close(),e.preventDefault()):-1<p.inArray(t,n.next)?(f.next(),e.preventDefault()):-1<p.inArray(t,n.prev)&&(f.prev(),e.preventDefault()))}),p.fn.mousewheel&&e.mouseWheel&&1<f.group.length&&f.wrap.bind("mousewheel.fb",function(e,t){var n=p(e.target).get(0);(0===n.clientHeight||n.scrollHeight===n.clientHeight&&n.scrollWidth===n.clientWidth)&&(e.preventDefault(),f[0<t?"prev":"next"]())}))},trigger:function(n){var e,i=f[-1<p.inArray(n,["onCancel","beforeLoad","afterLoad"])?"coming":"current"];if(i){if(p.isFunction(i[n])&&(e=i[n].apply(i,Array.prototype.slice.call(arguments,1))),!1===e)return!1;i.helpers&&p.each(i.helpers,function(e,t){t&&void 0!==f.helpers[e]&&p.isFunction(f.helpers[e][n])&&f.helpers[e][n](t,i)}),p.event.trigger(n+".fb")}},isImage:function(e){return e&&e.match(/\.(jpg|gif|png|bmp|jpeg)(.*)?$/i)},isSWF:function(e){return e&&e.match(/\.(swf)(.*)?$/i)},_start:function(e){var n,t,i,s={},o=f.group[e]||null;o&&(o.nodeType||o instanceof p)&&(n=!0,p.metadata&&(s=p(o).metadata())),s=p.extend(!0,{},f.opts,{index:e,element:o},p.isPlainObject(o)?o:s),p.each(["href","title","content","type"],function(e,t){s[t]=f.opts[t]||n&&p(o).attr(t)||s[t]||null}),"number"==typeof s.margin&&(s.margin=[s.margin,s.margin,s.margin,s.margin]),s.modal&&p.extend(!0,s,{closeBtn:!1,closeClick:!1,nextClick:!1,arrows:!1,mouseWheel:!1,keys:null,helpers:{overlay:{css:{cursor:"auto"},closeClick:!1}}}),f.coming=s,!1===f.trigger("beforeLoad")?f.coming=null:(t=s.type,e=s.href||o,t||(!n||!p(o).data("fancybox-type")&&o.className&&(t=(i=o.className.match(/fancybox\.(\w+)/))?i[1]:null),t||"string"!==p.type(e)||(f.isImage(e)?t="image":f.isSWF(e)?t="swf":e.match(/^#/)&&(t="inline")),t=t||(n?"inline":"html"),s.type=t),"inline"===t||"html"===t?(s.content||(s.content="inline"===t?p("string"===p.type(e)?e.replace(/.*(?=#[^\s]+$)/,""):e):o),s.content&&s.content.length||(t=null)):e||(t=null),s.group=f.group,s.isDom=n,s.href=e,"image"===t?f._loadImage():"ajax"===t?f._loadAjax():t?f._afterLoad():f._error("type"))},_error:function(e){f.hideLoading(),p.extend(f.coming,{type:"html",autoSize:!0,minHeight:0,hasError:e,content:f.coming.tpl.error}),f._afterLoad()},_loadImage:function(){f.imgPreload=new Image,f.imgPreload.onload=function(){this.onload=this.onerror=null,f.coming.width=this.width,f.coming.height=this.height,f._afterLoad()},f.imgPreload.onerror=function(){this.onload=this.onerror=null,f._error("image")},f.imgPreload.src=f.coming.href,f.imgPreload.width||f.showLoading()},_loadAjax:function(){f.showLoading(),f.ajaxLoad=p.ajax(p.extend({},f.coming.ajax,{url:f.coming.href,error:function(e,t){"abort"!==t?f._error("ajax",e):f.hideLoading()},success:function(e,t){"success"===t&&(f.coming.content=e,f._afterLoad())}}))},_preloadImages:function(){var e,t=f.group,n=f.current,i=t.length;if(n.preload&&!(t.length<2))for(var s=1;s<=Math.min(n.preload,i-1);s++)e=t[(n.index+s)%i],(e=p(e).attr("href")||e)&&((new Image).src=e)},_afterLoad:function(){f.hideLoading(),f.coming&&!1!==f.trigger("afterLoad",f.current)?(f.isOpened?(p(".fancybox-item").remove(),f.wrap.stop(!0).removeClass("fancybox-opened"),f.inner.css("overflow","hidden"),f.transitions[f.current.prevMethod]()):(p(".fancybox-wrap").stop().trigger("onReset").remove(),f.trigger("afterClose")),f.unbindEvents(),f.isOpen=!1,f.current=f.coming,f.wrap=p(f.current.tpl.wrap).addClass("fancybox-"+(o?"mobile":"desktop")+" fancybox-tmp "+f.current.wrapCSS).appendTo("body"),f.outer=p(".fancybox-outer",f.wrap).css("padding",f.current.padding+"px"),f.inner=p(".fancybox-inner",f.wrap),f._setContent()):f.coming=!1},_setContent:function(){var e,t,n=f.current,i=n.type;switch(i){case"inline":case"ajax":case"html":(e=n.content)instanceof p&&((e=e.show().detach()).parent().hasClass("fancybox-inner")&&e.parents(".fancybox-wrap").trigger("onReset").remove(),p(f.wrap).bind("onReset",function(){e.appendTo("body").hide()})),n.autoSize&&(t=p('<div class="fancybox-tmp '+f.current.wrapCSS+'"></div>').appendTo("body").append(e),n.width=t.width(),n.height=t.height(),t.width(f.current.width),t.height()>n.height&&(t.width(n.width+1),n.width=t.width(),n.height=t.height()),e=t.contents().detach(),t.remove());break;case"image":e=n.tpl.image.replace("{href}",n.href),n.aspectRatio=!0;break;case"swf":e=n.tpl.swf.replace(/\{width\}/g,n.width).replace(/\{height\}/g,n.height).replace(/\{href\}/g,n.href)}if("iframe"===i){if(e=p(n.tpl.iframe.replace("{rnd}",(new Date).getTime())).attr("scrolling",n.scrolling),n.scrolling="auto",n.autoSize)return e.width(n.width),f.showLoading(),void e.data("ready",!1).appendTo(f.inner).bind({onCancel:function(){p(this).unbind(),f._afterZoomOut()},load:function(){var e,t=p(this);try{this.contentWindow.document.location&&(e=t.contents().find("body").height()+12,t.height(e))}catch(e){n.autoSize=!1}!1===t.data("ready")?(f.hideLoading(),e&&(f.current.height=e),f._beforeShow(),t.data("ready",!0)):e&&f.update()}}).attr("src",n.href);e.attr("src",n.href)}else"image"!==i&&"swf"!==i||(n.autoSize=!1,n.scrolling="visible");f.inner.append(e),f._beforeShow()},_beforeShow:function(){f.coming=null,f.trigger("beforeShow"),f._setDimension(),f.wrap.hide().removeClass("fancybox-tmp"),f.bindEvents(),f._preloadImages(),f.transitions[f.isOpened?f.current.nextMethod:f.current.openMethod]()},_setDimension:function(){var e,t=f.wrap,n=f.outer,i=f.inner,s=f.current,o=f.getViewport(),a=s.margin,r=2*s.padding,l=s.width,c=s.height,d=s.maxWidth,u=s.maxHeight,h=s.minWidth,m=s.minHeight;if(o.w-=a[1]+a[3],o.h-=a[0]+a[2],-1<l.toString().indexOf("%")&&(l=(o.w-r)*parseFloat(l)/100),-1<c.toString().indexOf("%")&&(c=(o.h-r)*parseFloat(c)/100),a=l/c,l+=r,c+=r,s.fitToView&&(d=Math.min(o.w,d),u=Math.min(o.h,u)),s.aspectRatio?(d<l&&(c=((l=d)-r)/a+r),u<c&&(l=((c=u)-r)*a+r),l<h&&(c=((l=h)-r)/a+r),c<m&&(l=((c=m)-r)*a+r)):(l=Math.max(h,Math.min(l,d)),c=Math.max(m,Math.min(c,u))),l=Math.round(l),c=Math.round(c),p(t.add(n).add(i)).width("auto").height("auto"),i.width(l-r).height(c-r),t.width(l),e=t.height(),d<l||u<e)for(;(d<l||u<e)&&h<l&&m<e;)c-=10,s.aspectRatio?(l=Math.round((c-r)*a+r))<h&&(c=((l=h)-r)/a+r):l-=10,i.width(l-r).height(c-r),t.width(l),e=t.height();s.dim={width:l,height:e},s.canGrow=s.autoSize&&m<c&&c<u,s.canShrink=!1,s.canExpand=!1,l-r<s.width||c-r<s.height?s.canExpand=!0:(l>o.w||e>o.h)&&h<l&&m<c&&(s.canShrink=!0),t=e-r,f.innerSpace=t-i.height(),f.outerSpace=t-n.height()},_getPosition:function(e){var t=f.current,n=f.getViewport(),i=t.margin,s=f.wrap.width()+i[1]+i[3],o=f.wrap.height()+i[0]+i[2],a={position:"absolute",top:i[0]+n.y,left:i[3]+n.x};return t.fixed&&(!e||!1===e[0])&&o<=n.h&&s<=n.w&&(a={position:"fixed",top:i[0],left:i[3]}),a.top=Math.ceil(Math.max(a.top,a.top+(n.h-o)*t.topRatio))+"px",a.left=Math.ceil(Math.max(a.left,a.left+.5*(n.w-s)))+"px",a},_afterZoomIn:function(){var e=f.current,t=e.scrolling;f.isOpen=f.isOpened=!0,f.wrap.addClass("fancybox-opened").css("overflow","visible"),f.update(),f.inner.css("overflow","yes"===t?"scroll":"no"===t?"hidden":t),(e.closeClick||e.nextClick)&&f.inner.css("cursor","pointer").bind("click.fb",e.nextClick?f.next:f.close),e.closeBtn&&p(e.tpl.closeBtn).appendTo(f.outer).bind("click.fb",f.close),e.arrows&&1<f.group.length&&((e.loop||0<e.index)&&p(e.tpl.prev).appendTo(f.inner).bind("click.fb",f.prev),(e.loop||e.index<f.group.length-1)&&p(e.tpl.next).appendTo(f.inner).bind("click.fb",f.next)),f.trigger("afterShow"),f.opts.autoPlay&&!f.player.isActive&&(f.opts.autoPlay=!1,f.play())},_afterZoomOut:function(){f.trigger("afterClose"),f.wrap.trigger("onReset").remove(),p.extend(f,{group:{},opts:{},current:null,isActive:!1,isOpened:!1,isOpen:!1,wrap:null,outer:null,inner:null})}}),f.transitions={getOrigPosition:function(){var e=f.current,t=e.element,n=e.padding,i=p(e.orig),s={},o=50,a=50;return!i.length&&e.isDom&&p(t).is(":visible")&&((i=p(t).find("img:first")).length||(i=p(t))),i.length?(s=i.offset(),i.is("img")&&(o=i.outerWidth(),a=i.outerHeight())):(e=f.getViewport(),s.top=e.y+.5*(e.h-a),s.left=e.x+.5*(e.w-o)),{top:Math.ceil(s.top-n)+"px",left:Math.ceil(s.left-n)+"px",width:Math.ceil(o+2*n)+"px",height:Math.ceil(a+2*n)+"px"}},step:function(e,t){var n,i,s;"width"!==t.prop&&"height"!==t.prop||(i=s=Math.ceil(e-2*f.current.padding),"height"===t.prop&&(n=(e-t.start)/(t.end-t.start),t.start>t.end&&(n=1-n),i-=f.innerSpace*n,s-=f.outerSpace*n),f.inner[t.prop](i),f.outer[t.prop](s))},zoomIn:function(){var e,t=f.wrap,n=f.current,i=n.dim;"elastic"===n.openEffect?(delete(e=p.extend({},i,f._getPosition(!0))).position,i=this.getOrigPosition(),n.openOpacity&&(i.opacity=0,e.opacity=1),f.outer.add(f.inner).width("auto").height("auto"),t.css(i).show(),t.animate(e,{duration:n.openSpeed,easing:n.openEasing,step:this.step,complete:f._afterZoomIn})):(t.css(p.extend({},i,f._getPosition())),"fade"===n.openEffect?t.fadeIn(n.openSpeed,f._afterZoomIn):(t.show(),f._afterZoomIn()))},zoomOut:function(){var e,t=f.wrap,n=f.current;"elastic"===n.closeEffect?("fixed"===t.css("position")&&t.css(f._getPosition(!0)),e=this.getOrigPosition(),n.closeOpacity&&(e.opacity=0),t.animate(e,{duration:n.closeSpeed,easing:n.closeEasing,step:this.step,complete:f._afterZoomOut})):t.fadeOut("fade"===n.closeEffect?n.closeSpeed:0,f._afterZoomOut)},changeIn:function(){var e,t=f.wrap,n=f.current;"elastic"===n.nextEffect?((e=f._getPosition(!0)).opacity=0,e.top=parseInt(e.top,10)-200+"px",t.css(e).show().animate({opacity:1,top:"+=200px"},{duration:n.nextSpeed,easing:n.nextEasing,complete:f._afterZoomIn})):(t.css(f._getPosition()),"fade"===n.nextEffect?t.hide().fadeIn(n.nextSpeed,f._afterZoomIn):(t.show(),f._afterZoomIn()))},changeOut:function(){function e(){p(this).trigger("onReset").remove()}var t=f.wrap,n=f.current;t.removeClass("fancybox-opened"),"elastic"===n.prevEffect?t.animate({opacity:0,top:"+=200px"},{duration:n.prevSpeed,easing:n.prevEasing,complete:e}):t.fadeOut("fade"===n.prevEffect?n.prevSpeed:0,e)}},f.helpers.overlay={overlay:null,update:function(){var e;this.overlay.width(0).height(0),e=p.browser.msie?(e=Math.max(t.documentElement.scrollWidth,t.body.scrollWidth))<Math.max(t.documentElement.offsetWidth,t.body.offsetWidth)?i.width():e:s.width(),this.overlay.width(e).height(s.height())},beforeShow:function(e){this.overlay||(e=p.extend(!0,{speedIn:"fast",closeClick:!0,opacity:1,css:{background:"black"}},e),this.overlay=p('<div id="fancybox-overlay"></div>').css(e.css).appendTo("body"),this.update(),e.closeClick&&this.overlay.bind("click.fb",f.close),i.bind("resize.fb",p.proxy(this.update,this)),this.overlay.fadeTo(e.speedIn,e.opacity))},onUpdate:function(){this.update()},afterClose:function(e){this.overlay&&this.overlay.fadeOut(e.speedOut||0,function(){p(this).remove()}),this.overlay=null}},f.helpers.title={beforeShow:function(e){var t;(t=f.current.title)&&(t=p('<div class="fancybox-title fancybox-title-'+e.type+'-wrap">'+t+"</div>").appendTo("body"),"float"===e.type&&(t.width(t.width()),t.wrapInner('<span class="child"></span>'),f.current.margin[2]+=Math.abs(parseInt(t.css("margin-bottom"),10))),t.appendTo("over"===e.type?f.inner:"outside"===e.type?f.wrap:f.outer))}},p.fn.fancybox=function(o){function e(e){var t=this,n="rel",i=t[n],s=l;e.ctrlKey||e.altKey||e.shiftKey||e.metaKey||(e.preventDefault(),i||(n="data-fancybox-group",i=p(t).attr("data-fancybox-group")),i&&""!==i&&"nofollow"!==i&&(s=(t=(t=r.length?p(r):a).filter("["+n+'="'+i+'"]')).index(this)),o.index=s,f.open(t,o))}var a=p(this),r=this.selector||"",l=(o=o||{}).index||0;return r?s.undelegate(r,"click.fb-start").delegate(r,"click.fb-start",e):a.unbind("click.fb-start").bind("click.fb-start",e),this}}(window,document,jQuery),function(i,s){var e=i(window);i.extend(s.defaults,{wrapCSS:"ible-fancybox",scrolling:"visible",aspectRatio:!0,loop:!1,prevSpeed:600,nextSpeed:600,keys:{next:[13,32,39],prev:[37],close:[27]},helpers:{overlay:null,PhotosetOverlay:{}}}),s.transitions.changeIn=function(){var e=s.wrap,t=s.current,n=s._getPosition(!0);s.isForward?(n.left=parseInt(n.left,10)+1500+"px",e.css(n).show().animate({left:"-=1500px"},{duration:t.nextSpeed,complete:s._afterZoomIn})):(n.left=parseInt(n.left,10)-1500+"px",e.css(n).show().animate({left:"+=1500px"},{duration:t.nextSpeed,complete:s._afterZoomIn}))},s.transitions.changeOut=function(){var e,t=s.wrap,n=s.current;t.removeClass("fancybox-opened"),e=s.isForward?"-=1500px":"+=1500px","elastic"===n.prevEffect&&t.animate({opacity:.4,left:e},{duration:n.prevSpeed,complete:function(){i(this).trigger("onReset").remove()}})},s.next=function(){s.current&&(s.isForward=!0,s.jumpto(s.current.index+1))},s.prev=function(){s.current&&(s.isForward=!1,s.jumpto(s.current.index-1))},s.closeOrig=s.close,s.close=function(e){var t;("object"!=typeof e||!e.target||(t=i(e.target)).attr("id")===s.overlayId||t.hasClass("fancybox-close")&&i(this).attr("id")!==s.overlayId||t.hasClass("transparency"))&&s.closeOrig(e)},s._afterZoomOut=function(){s.trigger("afterClose")},s.getViewport=function(){return{x:e.scrollLeft(),y:0,w:e.width(),h:e.height()}},s.originalUrl=window.location.href,s.overlayId="ible-fancybox-overlay",s.overlayWrap='<div id="'+s.overlayId+'"><div class="transparency"></div></div>',s.helpers.PhotosetOverlay={overlay:null,beforeLoad:function(e){this.overlay||(e=i.extend(!0,{speedIn:"fast",closeClick:!0},e),this.overlay=i(s.overlayWrap).appendTo("body"),e.closeClick&&this.overlay.bind("click.fb",s.close),this.overlay.fadeTo(e.speedIn,e.opacity))},beforeShow:function(e){s.wrap.detach().appendTo("div#"+s.overlayId)},afterClose:function(e){s.wrap.trigger("onReset").remove(),this.overlay&&(this.overlay.remove(),this.overlay=null),i.extend(s,{group:{},opts:{},current:null,isActive:!1,isOpened:!1,isOpen:!1,wrap:null,outer:null,inner:null})}}}(jQuery,jQuery.fancybox),Ibles.views.FancyboxView=Backbone.View.extend({initialize:function(e){_.bindAll(this,"beforeShow","afterShow","afterClose"),this.menuBarView=null,this.opts=e,this.opts.targets.fancybox({beforeShow:this.beforeShow,afterShow:this.afterShow,afterClose:this.afterClose})},beforeShow:function(){this.cleanupMenuBar()},afterShow:function(){this.opts.afterShow&&this.opts.afterShow();var e=this.getCurrentImageUrl();Ibles.isGif(e)?this.swapGifWithVideo():Ibles.isCdnUrl(e)&&this.setupMenuBar()},afterClose:function(){this.cleanupMenuBar()},setupMenuBar:function(){var e=this.opts.canRotate;this.menuBarView=new Ibles.views.FancyboxMenuBar({el:$("#ible-fancybox-overlay"),showRotateOption:e&&e()})},cleanupMenuBar:function(){this.menuBarView&&(this.menuBarView.destroy(),this.menuBarView=null)},getCurrentImageUrl:function(){return $.fancybox.current.href},swapGifWithVideo:function(){var e=this.getCurrentImageUrl();Ibles.isGif(e)&&$("#ible-fancybox-overlay").find(".fancybox-image").replaceWith($("<video>",{class:"gif-video",autoplay:!0,muted:!0,playsinline:!0,controls:!0,src:Ibles.updateQueryParameter(e,"format","mp4")}).show())}}),Ibles.views.FancyboxMenuBar=Backbone.View.extend({events:{"click .image-rotate-angle":"rotate","click .image-rotate-save":"saveRotation"},initialize:function(e){this.angle=0,this.rotationCountSinceLastSave=0,this.$img=this.$(".fancybox-image"),this.$menuBar=null,this.showRotateOption=e.showRotateOption,this.originalHeight=this.$img.height(),this.originalWidth=this.$img.width(),this.appendMenuBar()},destroy:function(){this.$img=null,this.$menuBar=null,this.stopListening(),this.undelegateEvents()},appendMenuBar:function(){this.$menuBar=$('<div class="fancybox-menu-bar">'),$.fancybox.inner.append(this.$menuBar),this.appendDownloadLink(),this.showRotateOption&&(this.appendRotateAction(),this.appendSaveBtn())},appendDownloadLink:function(){this.$menuBar.append($("<a>",{class:"ible-download-link",title:"Download Original",target:"_blank",href:$($.fancybox.current.element).data("download").split("?")[0]}).append($("<img>",{src:Ibles.staticUrl("img/icon-download.png")}))).click(function(){Ibles.gaUserEvent("overlayImageDownload",{eventLabel:"photoset",eventValue:!0})})},appendRotateAction:function(){this.$menuBar.append($("<a>",{class:"image-rotate-angle",title:"Rotate Image"}).append($("<img>",{src:Ibles.staticUrl("svg/rotate.svg")})))},appendSaveBtn:function(){this.$menuBar.append($("<a>",{class:"image-rotate-save btn btn-orange",title:"Save Image"}).data({"loading-text":"Loading...","failed-text":"Failed","complete-text":"Success!"}).text("Save"))},rotate:function(){var e=this.originalHeight,t=this.originalWidth,n=0,i=1;switch(this.angle){case 0:n=90,i=e<=t?e/t:t/e;break;case 90:n=180,i=1;break;case 180:n=270,i=e<=t?e/t:t/e;break;case 270:n=0,i=1}this.angle=n,this.rotationCountSinceLastSave++,this.transform(this.$img,i,n),this.$(".image-rotate-save").show()},transform:function(e,t,n){var i="scale({0}) rotate({1}deg)".format(t,n),s=e.get(0);s.style.WebkitTransform=i,s.style.msTransform=i,s.style.transform=i},saveRotation:function(e){var s=this,t=$.fancybox.current,o=t.href,a=$(t.element),n=a.data("fileid"),i=this.rotationCountSinceLastSave%4*90,r=(new Ibles.services.ImageRotationService).rotateFileId(n,i).done(function(e){var t=e.file,n=window.md5(t.modifiedDate),i=o.split("?")[0]+"?md={0}".format(n);a.attr("href",i),a.find("img").attr("src",i),s.rotationCountSinceLastSave=0});Ibles.syncButtonStatesToRequest($(e.currentTarget),r)}}),Ibles.JST.photoset='<[ if (numVideos) {]>\n<div class="videoset-wrapper">   \n    <div class="videoset"></div>\n</div>\n<[}]>\n<[ if (numImages) {]>\n<div class="photoset-wrapper">\n    <div class="photoset"></div>\n</div>\n<[}]> \n',Ibles.JST["videoset-cell"]='<div class="videoset-cell">\n    <div class="videoset-item">\n        << embedHtmlCode >>\n    </div>\n</div>\n',Ibles.JST["photoset-cell"]='<div class="photoset-item photoset-cell" style="-webkit-flex: << aspectRatio >>; flex: << aspectRatio >>;">\n    <div class="photoset-image">\n        <[ if (isGif) {]>\n            <video class="gif-video" controls autoplay muted loop playsinline>\n                <source src="<< mp4Url >>" type="video/mp4">\n            </video>\n        <[ } else { ]>\n            <a class="gallery-link" rel="<< galleryId >>" href="<< overlayImageUrl >>" data-download="<< imageOriginalUrl >>" data-fileid="<< fileId >>">\n                <img class="lazyload" alt="<< title >>" src="<< Ibles.staticUrl(\'img/pixel.png\') >>" data-src="<< resizedImageUrl >>" <[ if (isGif) {]>data-gif-url="<< gifUrl >>"<[}]>>\n                <[ if (!_.isEmpty(imageNotes)) { ]>\n                    <i class="notes-icon"></i>\n                <[ } ]>\n            </a>\n        <[ } ]>\n    </div>\n</div>\n',function(u){u.fn.notes=function(e){var d={init:function(l,e,c){return d.setEditable(e),this.each(function(){var a=u(this),r=u('<div class="note-holder"></div>');return setTimeout(function(){var e,t,n,i,s,o=d.extractInfo(a,c);if(r.addClass(o.imgId),r.attr("id","holder_"+o.imgId),d.placeNoteHolder(r,o),null!=c?c.append(r):u("body").append(r),d.editable&&(r.css({"z-index":200}),d.bindNoteHolder(r)),e=function(e){var t;return e.parentWidth=o.width,e.parentHeight=o.height,e.noteHolder=r,t=[e],d.display.apply(a,t)},l){for(s=[],n=0,i=l.length;n<i;n++)t=l[n],s.push(e(t));return s}},10)})},extractInfo:function(e,t){var n,i=e.width(),s=e.height(),o=e.attr("class"),a=t?e.offsetParent().position():e.offset();return null!=o&&(n=o.indexOf(" ")),{width:i,height:s,offset:a,imgId:null!=n&&-1!==n?o.split(" ")[1]:o}},placeNoteHolder:function(e,t){if(null!=t&&null!=t.offset)return e.css({left:t.offset.left+"px",top:t.offset.top+"px"})},buildNoteInfo:function(e,t){var n,i,s,o,a,r=e.position(),l=e.parent(),c=l.width(),d=l.height(),u=l.attr("class").split(" ")[1].substring(3),h={};return h.action=t,h.imageID=u,o=r.top/d,i=r.left/c,a=e.width()/c,n=e.height()/d,(s=(s=e.find("textarea").val())||e.find(".note-text-value").html())&&(h.text=s.replace(/\n/g,"<br/>").replace(/"/g,'\\"')),h.json='{"top":'+o+',"left":'+i+',"width":'+a+',"height":'+n+',"text":"'+h.text+'"}',h},add:function(t){var n=d.buildNoteInfo(t,"ADD");return u.post("/ajax/imageNote",n,function(e){return t.attr("id",e),t.find(".note-text").html(d.buildTextNode(n.text.replace(/\\"/g,'"'))),d.bind(t)},"text")},buildTextNode:function(e){return u('<div class="note-text-value">'+e+'</div><a class="edit-note" href="#">edit</a>')},buildEditNode:function(e,t){return e=e.replace(/<br>/g,"\n"),u(t?"<textarea>"+e+'</textarea><br/><a class="delete little-button" href="#">delete</a><a class="'+t+' little-button" href="#">save</a>':"<textarea>"+e+'</textarea><br/><a class="delete little-button" href="#">delete</a><a class="save little-button" href="#">save</a>')},save:function(t){var e=d.buildNoteInfo(t,"MODIFY");if(e.noteID=t.attr("id"),e.noteID)return u.post("/ajax/imageNote",e,function(e){return d.bind(t)})},update:function(n){var i=n.find(".note-text"),e=i.find(".note-text-value").html();return i.html(d.buildEditNode(e,"edit")),d.bind(n),i.find("a.edit").click(function(e){var t;return e.preventDefault(),null!=(t=d.buildNoteInfo(n,"MODIFY")).text?(t.noteID=n.attr("id"),u.post("/ajax/imageNote",t,function(e){return i.html(d.buildTextNode(i.find("textarea").val())),d.bind(n)})):feedBack.add("Please enter text in order to save.")})},remove:function(e){var t=d.buildNoteInfo(e,"DELETE");return t.noteID=e.attr("id"),t.noteID&&u.post("/ajax/imageNote",t),e.fadeOut(function(){return e.remove()})},bindNoteHolder:function(t){var n=null;return u("div.note-holder").mousedown(function(e){return e.preventDefault(),n=d.userCreateBox(e,t),d.bind(n,n.height())}),this},display:function(e){var t=Math.round(e.parentWidth*e.left),n=Math.round(e.parentHeight*e.top),i=Math.round(e.parentWidth*e.width),s=Math.round(e.parentHeight*e.height);return d.drawBox({left:t,top:n,width:i,height:s,note:e}),this},drawBox:function(e){var t=e.note.id?e.note.id:e.note.noteID,n=u('<div id="'+t+'" class="note-border"><div class="note-text"><div class="note-text-value">'+e.note.text+"</div></div></div>");return e.note.noteHolder.append(n),d.editable&&n.find(".note-text").append('<a href="#" class="edit-note">edit</a>'),n.css({width:e.width+"px",left:e.left+"px",height:e.height+"px",top:e.top+"px"}),d.bind(n,e.height),this},userCreateBox:function(e,t){var n=u('<div class="note-border"><div class="note-text"></div></div>');return n.find(".note-text").append(d.buildEditNode("")),t.append(n),n.mousedown(function(e){return e.stopPropagation()}),/MSIE (\d+\.\d+);/.test(navigator.userAgent)?n.css({top:e.offsetY+"px",left:e.offsetX+"px",width:"50px",height:"50px"}):n.css({top:e.layerY+"px",left:e.layerX+"px",width:"50px",height:"50px"}),n},updateBoxSize:function(e,t){var n=t.position();return t.css({width:Math.abs(n.left+e.layerX)+"px",height:Math.abs(n.top+e.layerY)+"px"})},setNoteTextTop:function(e,t){return e.css({top:t+"px"})},noteHover:function(e,t,n){var i=this;return e.hover(function(){return clearTimeout(i.timer),d.setNoteTextTop(n,t),u("div.note-text").hide(),n.show()},function(){return clearTimeout(i.timer),i.timer=setTimeout(function(){return n.fadeOut()},1500)})},setEditable:function(e){return this.editable=e,this},bind:function(n,i){var s=n.find("div.note-text"),o=d.noteHover(n,i,s);if(d.editable)return null!=n.resizable&&n.resizable({containment:"parent",start:function(e,t){return s.hide(),n.unbind("hover",o)},resize:function(e,t){return s.hide(),n.unbind("hover",o)},stop:function(e,t){return i=n.height(),o=d.noteHover(n,i,s),d.setNoteTextTop(s,i),d.save(n),s.show()}}),null!=n.draggable&&n.draggable({containment:"parent",stop:function(e,t){return d.save(n)}}),n.mousedown(function(e){return e.stopPropagation()}),s.find("a.save").click(function(e){return e.preventDefault(),d.add(n)}),s.find("a.delete").click(function(e){return e.preventDefault(),d.remove(n)}),s.find("a.edit-note").click(function(e){return e.preventDefault(),d.update(n)})}};return d[e]?d[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?u.error("Method "+e+" does not exist on jQuery.notes"):d.init.apply(this,arguments)}}(window.jQuery),function(w,l){w.package("Ibles.views");var n={enableCropping:!0,maxRowHeight:700,maxWidth:1200,singleRowAspectRatioMax:.75,minCellAspect:{ratio:2/3,ratioRnded:.7,cropParam:"2:3"},maxCellAspect:{ratio:1.5,ratioRnded:1.5,cropParam:"3:2"},maxImageWidthsByType:{small:320,medium:620,large:1024}};w.views.PhotosetView=Backbone.View.extend({template:_.template(w.JST.photoset),model:null,events:{"click .gallery-link":"renderGalleryOverlay","click .photoset-showmore":"showHiddenRows"},initialize:function(e){var t=_.clone(n);this.title=e.title,this.galleryId=_.uniqueId("photoset"),this.rows=[],this.rowAspectRatios={},this.settings=_.extend(t,_.pick(e,_.keys(t))),this.render(e.fileCollection)},placeImageCellsInRows:function(e){var t=this.setRowAndColIndexForCells,n=e.length,i=[],s=(n-1)%3==0?4:3,o=e.slice(0,s);if(t(o,0),i.push(o),5<=n)for(var a,r=e.slice(s),l=r.length,c=0,d=1;c<l;c+=3,d++)(a=r.slice(c,c+3)).length&&(t(a,d),i.push(a));return this.rows=i},setRowAndColIndexForCells:function(e,n){e.forEach(function(e,t){0==n?(e.setRowIndex(0),e.setColIndex(0==t?0:1)):(e.setRowIndex(n),e.setColIndex(t))})},getRowAspectRatios:function(e){var t,n,i=this.rowAspectRatios[e];return i||(t=this.rows[e],n=0==e&&this.firstRowRequiresMultiDimensionalLayout()?[t[0].aspectRatio,1/_.reduce(t.slice(1),function(e,t){return e+1/t.aspectRatio},0)]:_.map(t,function(e){return e.aspectRatio}),this.rowAspectRatios[e]=n)},firstRowRequiresMultiDimensionalLayout:function(){var e=this.rows[0],t=this.settings.singleRowAspectRatioMax;return 2<e.length&&_.some(_.map(e,function(e){return e.aspectRatio}),function(e){return t<e})},getEffectiveMaxWidth:function(){var e,t,n,i,s,o=this.effectiveMaxWidth;return o||(t=(e=this.settings).maxWidth,n=e.maxRowHeight,i=this.getRowAspectRatios(0),s=_.reduce(i,function(e,t){return e+t},0),this.effectiveMaxWidth=Math.min(n*s,t))},renderGalleryOverlay:function(e){var t=this;e.preventDefault(),new w.views.FancyboxView({targets:this.$(".gallery-link"),afterShow:t.renderImageNotes,canRotate:function(){return t.model.isEditableByCurrentUser()||w.session.isAdmin()}})},renderImageNotes:function(){var e,t,n=$.fancybox.inner,i=$($.fancybox.current.element);n.length&&(e=i.closest(".photoset-cell").data("imagenotes"),t=n.find("img:first"),e&&t.notes(e,!1,n))},showHiddenRows:function(e){e.preventDefault();var n=this.$(".photoset-showmore"),i=this.$(".hidden-row"),t=i.find("img"),s=t.length;this.$(".loading").show(),t.each(function(e,t){t.src=t.getAttribute("data-src"),t.onload=function(){--s||(i.removeClass("hidden-row"),n.remove())}})},render:function(e){var t=e.groupBy(function(e){return"VIDEO"==e.getEmbedType()?"videoFiles":"imageFiles"}),n=t.imageFiles||[],i=t.videoFiles||[],s=n.length,o=i.length,a=$(this.template({numImages:s,numVideos:o}));o&&this.renderVideoFiles(i,a),s&&this.renderImageFiles(n,a),this.$el.append(a)},renderVideoFiles:function(e,t){var n=t.find(".videoset");e.forEach(function(e){var t=new w.views.VideosetCell({file:e});n.append(t.load())})},renderImageFiles:function(p,e){function f(e){var t=l.createElement("div");return t.innerHTML=e,t.firstChild}var g=this,b=e.find(".photoset"),t=p.map(function(e){return new w.views.PhotosetCell({file:e},g)}),n=g.placeImageCellsInRows(t),v=n.length,i=g.settings.maxWidth,s=g.getEffectiveMaxWidth();n.forEach(function(e,t){var n,i,s,o,a,r,l,c=0<t,d=0,u=e.length,h=f('<div class="photoset-row items-{0} {1}"></div>'.format(u,0<t?" hidden-row":"")),m=h;0==t&&g.firstRowRequiresMultiDimensionalLayout()&&(s=g.getRowAspectRatios(0),o=s[1],n=f('<div class="photoset-col" style="-webkit-flex:{0};flex:{1};"></div>'.format(o,o)),h.appendChild(e[0].load(c)),h.appendChild(n),m=n,d=1),e.slice(d).forEach(function(e){i=e.load(c),m.appendChild(i)}),0==t&&1<v&&(a=i,r=p.length-u,l=f('<div class="photoset-showmore"><img class="loading" src="{0}">{1} More Images</div>'.format(w.staticUrl("img/ajax_loader_48px.gif"),r)),a.querySelector(".photoset-image").appendChild(l)),b.append(h)}),s<i&&(b.get(0).style.maxWidth=s+"px")}}),w.views.VideosetCell=Backbone.View.extend({template:_.template(w.JST["videoset-cell"]),initialize:function(e){this.file=e.file},load:function(){var e=this.file,t=l.createElement("div");return t.innerHTML=this.template({embedHtmlCode:w.makeSafeForSSL(e.getEmbedHtmlCode())}),t.firstChild}}),w.views.PhotosetCell=Backbone.View.extend({template:_.template(w.JST["photoset-cell"]),initialize:function(e,t){var n=this;n.file=e.file,n.photoset=t,n.rowIndex=0,n.colIndex=0,n.setAspectRatio()},setRowIndex:function(e){this.rowIndex=e},setColIndex:function(e){this.colIndex=e},setAspectRatio:function(){var e,t=this.file,n=t.getWidth()/t.getHeight(),i=Math.round(10*n)/10,s=this.photoset.settings,o=s.minCellAspect,a=s.maxCellAspect,r=o.ratio,l=o.ratioRnded,c=a.ratio,d=a.ratioRnded;i<l?(n=r,e=o.cropParam):d<i&&(n=c,e=a.cropParam),this.aspectRatio=n,this.cropParam=e},load:function(e){var t,n,i=this,s=i.file,o=i.photoset,a=i.template({fileId:s.get("id"),title:o.title,galleryId:o.galleryId,resizedImageUrl:i.getCellImageUrl(),isGif:s.isGif(),gifUrl:s.getLargeAnimationUrl(),mp4Url:s.getMp4Url(),overlayImageUrl:s.getLargeUrl(),imageOriginalUrl:s.getOriginalUrl(),imageNotes:s.getImageNotes(),aspectRatio:i.aspectRatio,lazy:e}),r=l.createElement("div");return r.innerHTML=a,(n=(t=r.firstChild).dataset)&&(n.imagenotes=JSON.stringify(i.file.getImageNotes()||[])),t},getCellImageUrl:function(){var e=this,t=e.file,n=e.photoset,i=e.rowIndex,s=e.colIndex,o=n.settings,a=1<n.rows[i].length,r=o.enableCropping&&(a||!a&&e.aspectRatio<e.maxCropAspectRatio),l=n.getEffectiveMaxWidth(),c=o.maxImageWidthsByType,d=n.getRowAspectRatios(i),u=_.reduce(d,function(e,t){return e+t},0),h=Math.round(d[s]/u*l),m=e.cropParam,p={frame:!0,width:1024,height:1024,fit:"bounds"};return h<t.getWidth()&&h<c.large&&(p.width=h),r&&m&&(p.crop=m),t.getOptimizedImageUrl(p)}})}(Ibles,(window,document)),Ibles.JST["comment-item"]='<article class="post js-comment <[ if (isReply) {]>reply<[}]> <[ if (!visible) {]>hide<[}]>" data-id="<< id >>" data-stepid="<< stepId >>" <[ if (isReply) {]>data-inreplyto="<< replyAuthor >>"<[}]>>\n    <div class="post-header">\n        <div class="meta">\n            <[ if (Ibles.isDesktop()) {]>\n                <div class="votes js-vote-count <[ if (!upvotingEnabled || !rating) {]>hide<[}]>"><< rating >></div>\n            <[}]>\n\n            <div class="avatar">\n                <a href="<< authorUrl >>">\n                    <img <[ if (lazyImage) {]>class="lazyload" src="<< Ibles.staticUrl(\'img/pixel.png\') >>" data-<[}]>src="<< avatar >>">\n                </a>\n            </div>\n            <div class="posted-by">\n                <a class="author" href="<< authorUrl >>"><< author >></a>\n                <[ if (isReply) {]>\n                    <i class="icon-arrow-right"></i>\n                    <button class="replied-to js-reply-parent" href="<< Ibles.reverseUrls.memberUrl(replyAuthor) >>"><< replyAuthor >></button>\n                <[}]>\n                <p class="posted-date">\n                    <[ if (isQuestion) {]>\n                    <span class="label question-label">Question</span>\n                    <[} else if (isTip) {]>\n                    <span class="label tip-label">Tip</span>\n                    <[} else if (isBestAnswer) {]>\n                    <span class="label best-answer-label">Best Answer</span>\n                    <[} else if (!isReply) {]>\n\n                    <[} else {]>\n                         <[ if (isAnswer) {]>Answer<[} else {]>Reply<[}]>\n                    <[}]>\n                    << commentTime >>\n                    <[ if (stepId){ ]>on <a class="step-link" href="#<< stepAnchorId >>"><< stepIndexLabel >></a><[}]>\n                </p>\n            </div>\n        </div>\n        <[ if (Ibles.isDesktop()) {]>\n            <div class="toolbar js-toolbar">\n                <[ if (replyEnabled) {]>\n                    <button class="btn reply-btn js-reply"><[ if (isQuestion) {]>Answer<[}else{]>Reply<[}]></button>\n                <[ } ]>\n                <[ if (upvotingEnabled) {]>\n                    <button class="btn vote-btn js-vote-btn">Upvote</button>\n                <[ } ]>\n                <[ if (isAnswer) {]>\n                    <p class="best-answer-actions">\n                        <button class="btn btn-default js-toggle-best-answer hide"><[ if (isAnswer){]>Select as Best Answer<[}else{]>Undo Best Answer<[}]></button>\n                    </p>\n                <[}]>\n            </div>\n        <[}]>\n    </div>\n\n    <div class="text js-text">\n        <p class="quarantine-message js-quarantine-message"></p>\n        << body >>\n    </div>\n\n    <div class="js-edit-container"></div>\n\n    <div class="photos js-photos"></div>\n    <div class="attachments js-attachments"></div>\n\n    <[ if (lastVisibleInThread) {]>\n        <button class="hidden-replies-link js-show-replies">\n            << numRepliesFromMe >>\n            <[ if (isQuestion || isAnswer) {]>\n                << Ibles.pluralize(numRepliesFromMe, "answer", "answers") >>\n            <[} else {]>\n                << Ibles.pluralize(numRepliesFromMe, "reply", "replies") >>\n            <[}]>\n            <i class="icon-arrow-down"></i>\n        </button>\n    <[}]>\n\n    <[ if (Ibles.isMobile()) {]>\n        <div class="toolbar js-toolbar">\n            <div class="votes js-vote-count <[ if (!upvotingEnabled || !rating) {]>hide<[}]>"><< rating >></div>\n            <button class="btn reply-btn js-reply"><[ if (isQuestion) {]>Answer<[}else{]>Reply<[}]></button>\n            <[ if (upvotingEnabled) {]>\n                <button class="btn vote-btn js-vote-btn">Upvote</button>\n            <[ } ]>\n        </div>\n        <[ if (isAnswer) {]>\n            <p class="best-answer-actions">\n                <button class="btn btn-default js-toggle-best-answer hide"><[ if (isAnswer){]>Select as Best Answer<[}else{]>Undo Best Answer<[}]></button>\n            </p>\n        <[}]>\n    <[}]>\n</article>\n',Ibles.JST["comment-toolbar"]='<div class="toolbar js-toolbar">\n    <[ if (Ibles.isMobile()) {]>\n        <div class="votes js-vote-count <[ if (!rating) {]>hide<[}]>"><< rating >></div>\n    <[}]>\n    <button class="btn reply-btn js-reply">\n        <[ if (isQuestion) {]>Answer<[}else{]>Reply<[}]>\n    </button>\n    <[ if (upvotingEnabled) {]>\n    <button class="btn vote-btn js-vote-btn">Upvote</button>\n    <[ } ]>\n<[ if (Ibles.isMobile()) {]>\n</div>\n<[ } ]>\n<[ if (isAnswer) {]>\n    <p class="best-answer-actions">\n        <a class="btn btn-default js-toggle-best-answer hide"><[ if (isAnswer){]>Select as Best Answer<[}else{]>Undo Best Answer<[}]></a>\n    </p>\n<[}]>\n<[ if (Ibles.isDesktop()) {]>\n</div>\n<[ } ]>\n',Ibles.JST["comment-posting-view"]='<div class="discuss <[ if (!typeSelected) {]>discuss-all<[}]>">\n    <[ if (isMobile) {]>\n    <div class="postbox">\n        <img class="poster" src="<< avatar >>">\n        <p class="policy">We have a <b>be nice</b> policy.<br> Be positive and constructive.</p>\n    </div>\n    <[ } ]>\n    <div class="postbox">\n        <[ if (!isMobile) {]>\n        <img class="poster" src="<< avatar >>">\n        <[ } ]>\n        <div class="field js-redactor-container">\n            <[ if (!typeSelected) {]>\n                <button class="type-btn tip-type js-type-tip"><[ if (isMobile){]>Tip<[}else{]>Add Tip<[}]></button>\n                <button class="type-btn question-type js-type-question"><[ if (isMobile){]>Question<[}else{]>Ask Question<[}]></button>\n                <button class="type-btn comment-type js-type-comment"><[ if (isMobile){]>Comment<[}else{]>Post Comment<[}]></button>\n            <[ } else { ]>\n                <div class="comment-tip redactor-tooltip" data-toggle="tooltip" data-placement="top" title="Highlight text to apply styling"></div>\n                <textarea class="body-input js-body-input redactor-textarea"><[ if (commentBody){ ]><< commentBody >><[}]></textarea>\n            <[ } ]>\n        </div>\n    </div>\n    <div class="image-bucket js-image-bucket clearfix"></div>\n    <div class="alert alert-danger alert-error"></div>\n    <[ if (isIMadeIt) { ]>\n    <div class="alert alert-info imadeit-alert">\n        Please include at least one image of what you made. Add images below.\n    </div>\n    <[ } ]>\n    <div class="actions">\n        <[ if (!isMobile) {]>\n            <p class="policy">We have a <b>be nice</b> policy.<br> Please be positive and constructive.</p>\n        <[}]>\n        <[ if (isEdit) {]>\n            <button class="btn cancel-btn">Cancel</button>\n        <[ } ]>\n        <button class="btn add-image-btn" <[ if (!typeSelected) {]> disabled<[}]>>\n            <img class="uploading-indicator" src="<< Ibles.staticUrl(\'img/ajax_loader_48px.gif\') >>"> Add Images\n        </button>\n        <button class="btn btn-yellow post-btn" <[ if (!typeSelected) {]> disabled<[}]>>\n            <img class="posting-indicator" src="<< Ibles.staticUrl(\'img/ajax_loader_48px.gif\') >>"> <[ if (!submitLabel) {]>Post<[ } else { ]><< submitLabel >><[ } ]>\n        </button>\n    </div>\n</div>\n',Ibles.JST["comment-hidden-replies-toggler"]='<a class="hidden-replies-link js-show-replies" role="button">\n    << replyCountlabel >><i class="icon-arrow-down"></i>\n</a>',Ibles.JST["comment-author-opts"]='<button class="pull-left edit-comment js-edit hide-mobile">Edit</button>\n<[ if (hasChildren){]>\n    <button class="pull-left delete-comment js-del-thread">Delete Thread</button>\n<[ } else { ]>\n    <button class="pull-left delete-comment js-del-comment">Delete</button>\n<[ } ]>\n',Ibles.JST["comment-modal"]='<div class="modal fade comment-modal << modalClass >>">\n    <div class="modal-dialog modal-sm">\n        <div class="modal-content">\n            <div class="modal-body">\n                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>\n                <div class="js-gallery"></div>\n                <div class="primary-comment">\n                    <div class="js-primary-comment">\n                        <div class="loader">\n                            <img class="comment-modal-loader" src="<< Ibles.staticUrl(\'img/ajax_loader_48px.gif\') >>">\n                        </div>\n                    </div>\n                </div>\n                <div class="discussions js-replies">\n                    <div class="replies js-comments"></div>\n                </div>\n            </div>\n            <[ if (!hideNavigation) { ]>\n                <a href="javascript:void(0);" title="Next" class="js-next fancybox-nav fancybox-next"><span></span></a>\n                <a href="javascript:void(0);" title="Previous" class="js-prev fancybox-nav fancybox-prev"><span></span></a>\n            <[ } ]>\n        </div>\n    </div>\n</div>\n',Ibles.JST["comment-modal-gallery"]='<div class="scrollable-cards comment-modal-gallery <[ if (willScroll){]>will-scroll<[}]>">\n    <div class="scrollable-cards-inner" <[ if (willScroll) {]>style="height:<< galleryHeight >>px"<[}]>>\n        <[ _.each(imageFiles, function(file) { ]>\n            <div class="scrollable-card ">\n                <a href="<< file.getLargeAnimationUrl() >>" target="_blank"><img src="<< file.getOptimizedImageUrl({height: galleryHeight, frame: false}) >>"></a>\n            </div>\n        <[ }); ]>\n    </div>\n    <button class="control left-control hide-mobile" title="Previous"><i class="icon icon-arrow-left"></i></button>\n    <button class="control right-control hide-mobile <[ if (willScroll){]>active<[}]>" title="Next"><i class="icon icon-arrow-right"></i></button>\n</div>\n',Ibles.JST["comment-attached-file"]='<div class="file-info">\n    <a class="thumb-wrapper" href="<< attachmentUrl >>" download="<< name >>">\n        <span class="file-thumb"><img class="tiny-img" src="<< typeThumbnail >>" alt="<< name >>"></span>\n        <span class="title"><< name >></span>\n    </a>\n    <div class="file-actions">\n        <a href="<< attachmentUrl >>" download="<< name >>" class="btn pull-right">Download</a>\n    </div>\n</div>\n',Ibles.JST["comment-delete-prompt"]='<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>\n    <h3 class="center"><< title >></h3>\n</div>\n<div class="modal-body clearfix">\n    <p class="center">Are you sure you want to delete it?</p>\n    <button class="btn btn-yellow btn-lg delete-btn pull-right"> Delete </button>\n    <button data-dismiss="modal" class="btn btn-lg pull-right cancel-btn"> Cancel </button>\n    <p class="center alert-error hide">Oops! There was a problem deleting.</p>\n</div>\n',function(){"use strict";var ut="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){function t(e,t){var n,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},s=Object.create(e.prototype);for(n in i)s[n]=i[n];return(s.constructor=t).prototype=s,t}function n(e){e=e||{},this.defaultProtocol=e.defaultProtocol||l.defaultProtocol,this.events=e.events||l.events,this.format=e.format||l.format,this.formatHref=e.formatHref||l.formatHref,this.nl2br=e.nl2br||l.nl2br,this.tagName=e.tagName||l.tagName,this.target=e.target||l.target,this.validate=e.validate||l.validate,this.ignoreTags=[],this.attributes=e.attributes||e.linkAttributes||l.attributes,this.className=e.className||e.linkClass||l.className;for(var t=e.ignoreTags||l.ignoreTags,n=0;n<t.length;n++)this.ignoreTags.push(t[n].toUpperCase())}function i(e){return e}function s(){return function(e){this.j=[],this.T=e||null}}function o(e,t,n,i){for(var s=0,o=e.length,a=t,r=[],l=void 0;s<o&&(l=a.next(e[s]));)a=l,s++;if(o<=s)return[];for(;s<o-1;)l=new u(i),r.push(l),a.on(e[s],l),a=l,s++;return l=new u(n),r.push(l),a.on(e[o-1],l),r}function a(){return function(e){e&&(this.v=e)}}function r(e){return t(m,a(),e?{v:e}:{})}var l={defaultProtocol:"http",events:null,format:i,formatHref:i,nl2br:!1,tagName:"a",target:function(e,t){return"url"===t?"_blank":null},validate:!0,ignoreTags:[],attributes:null,className:"linkified"};n.prototype={resolve:function(e){var t=e.toHref(this.defaultProtocol);return{formatted:this.get("format",e.toString(),e),formattedHref:this.get("formatHref",t,e),tagName:this.get("tagName",t,e),className:this.get("className",t,e),target:this.get("target",t,e),events:this.getObject("events",t,e),attributes:this.getObject("attributes",t,e)}},check:function(e){return this.get("validate",e.toString(),e)},get:function(e,t,n){var i=this[e];if(!i)return i;switch(void 0===i?"undefined":ut(i)){case"function":return i(t,n.type);case"object":var s=i[n.type]||l[e];return"function"==typeof s?s(t,n.type):s}return i},getObject:function(e,t,n){var i=this[e];return"function"==typeof i?i(t,n.type):i}};var c=Object.freeze({defaults:l,Options:n,contains:function(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return!0;return!1}}),d=s();d.prototype={defaultTransition:!1,on:function(e,t){if(e instanceof Array){for(var n=0;n<e.length;n++)this.j.push([e[n],t]);return this}return this.j.push([e,t]),this},next:function(e){for(var t=0;t<this.j.length;t++){var n=this.j[t],i=n[0],s=n[1];if(this.test(e,i))return s}return this.defaultTransition},accepts:function(){return!!this.T},test:function(e,t){return e===t},emit:function(){return this.T}};var u=t(d,s(),{test:function(e,t){return e===t||t instanceof RegExp&&t.test(e)}}),h=t(d,s(),{jump:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=this.next(new e(""));return n===this.defaultTransition?(n=new this.constructor(t),this.on(e,n)):t&&(n.T=t),n},test:function(e,t){return e instanceof t}}),m=a();m.prototype={toString:function(){return this.v+""}};function p(e){return new u(e)}var f=r(),g=r("@"),b=r(":"),v=r("."),w=r(),y=r(),I=r("\n"),C=r(),x=r("+"),k=r("#"),S=r(),T=r("mailto:"),A=r("?"),M=r("/"),j=r("_"),P=r(),$=r(),E=r(),R=r("{"),_=r("["),O=r("<"),U=r("("),D=r("}"),N=r("]"),F=r(">"),L=r(")"),B=r("&"),V=Object.freeze({Base:m,DOMAIN:f,AT:g,COLON:b,DOT:v,PUNCTUATION:w,LOCALHOST:y,NL:I,NUM:C,PLUS:x,POUND:k,QUERY:A,PROTOCOL:S,MAILTO:T,SLASH:M,UNDERSCORE:j,SYM:P,TLD:$,WS:E,OPENBRACE:R,OPENBRACKET:_,OPENANGLEBRACKET:O,OPENPAREN:U,CLOSEBRACE:D,CLOSEBRACKET:N,CLOSEANGLEBRACKET:F,CLOSEPAREN:L,AMPERSAND:B}),z="aaa|aarp|abb|abbott|abogado|ac|academy|accenture|accountant|accountants|aco|active|actor|ad|adac|ads|adult|ae|aeg|aero|af|afl|ag|agency|ai|aig|airforce|airtel|al|alibaba|alipay|allfinanz|alsace|am|amica|amsterdam|an|analytics|android|ao|apartments|app|apple|aq|aquarelle|ar|aramco|archi|army|arpa|arte|as|asia|associates|at|attorney|au|auction|audi|audio|author|auto|autos|avianca|aw|ax|axa|az|azure|ba|baidu|band|bank|bar|barcelona|barclaycard|barclays|bargains|bauhaus|bayern|bb|bbc|bbva|bcg|bcn|bd|be|beats|beer|bentley|berlin|best|bet|bf|bg|bh|bharti|bi|bible|bid|bike|bing|bingo|bio|biz|bj|black|blackfriday|bloomberg|blue|bm|bms|bmw|bn|bnl|bnpparibas|bo|boats|boehringer|bom|bond|boo|book|boots|bosch|bostik|bot|boutique|br|bradesco|bridgestone|broadway|broker|brother|brussels|bs|bt|budapest|bugatti|build|builders|business|buy|buzz|bv|bw|by|bz|bzh|ca|cab|cafe|cal|call|camera|camp|cancerresearch|canon|capetown|capital|car|caravan|cards|care|career|careers|cars|cartier|casa|cash|casino|cat|catering|cba|cbn|cc|cd|ceb|center|ceo|cern|cf|cfa|cfd|cg|ch|chanel|channel|chase|chat|cheap|chloe|christmas|chrome|church|ci|cipriani|circle|cisco|citic|city|cityeats|ck|cl|claims|cleaning|click|clinic|clinique|clothing|cloud|club|clubmed|cm|cn|co|coach|codes|coffee|college|cologne|com|commbank|community|company|compare|computer|comsec|condos|construction|consulting|contact|contractors|cooking|cool|coop|corsica|country|coupon|coupons|courses|cr|credit|creditcard|creditunion|cricket|crown|crs|cruises|csc|cu|cuisinella|cv|cw|cx|cy|cymru|cyou|cz|dabur|dad|dance|date|dating|datsun|day|dclk|de|dealer|deals|degree|delivery|dell|deloitte|delta|democrat|dental|dentist|desi|design|dev|diamonds|diet|digital|direct|directory|discount|dj|dk|dm|dnp|do|docs|dog|doha|domains|download|drive|dubai|durban|dvag|dz|earth|eat|ec|edeka|edu|education|ee|eg|email|emerck|energy|engineer|engineering|enterprises|epson|equipment|er|erni|es|esq|estate|et|eu|eurovision|eus|events|everbank|exchange|expert|exposed|express|fage|fail|fairwinds|faith|family|fan|fans|farm|fashion|fast|feedback|ferrero|fi|film|final|finance|financial|firestone|firmdale|fish|fishing|fit|fitness|fj|fk|flickr|flights|florist|flowers|flsmidth|fly|fm|fo|foo|football|ford|forex|forsale|forum|foundation|fox|fr|fresenius|frl|frogans|frontier|fund|furniture|futbol|fyi|ga|gal|gallery|gallup|game|garden|gb|gbiz|gd|gdn|ge|gea|gent|genting|gf|gg|ggee|gh|gi|gift|gifts|gives|giving|gl|glass|gle|global|globo|gm|gmail|gmbh|gmo|gmx|gn|gold|goldpoint|golf|goo|goog|google|gop|got|gov|gp|gq|gr|grainger|graphics|gratis|green|gripe|group|gs|gt|gu|gucci|guge|guide|guitars|guru|gw|gy|hamburg|hangout|haus|hdfcbank|health|healthcare|help|helsinki|here|hermes|hiphop|hitachi|hiv|hk|hm|hn|hockey|holdings|holiday|homedepot|homes|honda|horse|host|hosting|hoteles|hotmail|house|how|hr|hsbc|ht|hu|hyundai|ibm|icbc|ice|icu|id|ie|ifm|iinet|il|im|immo|immobilien|in|industries|infiniti|info|ing|ink|institute|insurance|insure|int|international|investments|io|ipiranga|iq|ir|irish|is|iselect|ist|istanbul|it|itau|iwc|jaguar|java|jcb|je|jetzt|jewelry|jlc|jll|jm|jmp|jo|jobs|joburg|jot|joy|jp|jpmorgan|jprs|juegos|kaufen|kddi|ke|kerryhotels|kerrylogistics|kerryproperties|kfh|kg|kh|ki|kia|kim|kinder|kitchen|kiwi|km|kn|koeln|komatsu|kp|kpn|kr|krd|kred|kuokgroup|kw|ky|kyoto|kz|la|lacaixa|lamborghini|lamer|lancaster|land|landrover|lanxess|lasalle|lat|latrobe|law|lawyer|lb|lc|lds|lease|leclerc|legal|lexus|lgbt|li|liaison|lidl|life|lifeinsurance|lifestyle|lighting|like|limited|limo|lincoln|linde|link|live|living|lixil|lk|loan|loans|local|locus|lol|london|lotte|lotto|love|lr|ls|lt|ltd|ltda|lu|lupin|luxe|luxury|lv|ly|ma|madrid|maif|maison|makeup|man|management|mango|market|marketing|markets|marriott|mba|mc|md|me|med|media|meet|melbourne|meme|memorial|men|menu|meo|mg|mh|miami|microsoft|mil|mini|mk|ml|mm|mma|mn|mo|mobi|mobily|moda|moe|moi|mom|monash|money|montblanc|mormon|mortgage|moscow|motorcycles|mov|movie|movistar|mp|mq|mr|ms|mt|mtn|mtpc|mtr|mu|museum|mutuelle|mv|mw|mx|my|mz|na|nadex|nagoya|name|natura|navy|nc|ne|nec|net|netbank|network|neustar|new|news|nexus|nf|ng|ngo|nhk|ni|nico|nikon|ninja|nissan|nl|no|nokia|norton|nowruz|np|nr|nra|nrw|ntt|nu|nyc|nz|obi|office|okinawa|om|omega|one|ong|onl|online|ooo|oracle|orange|org|organic|origins|osaka|otsuka|ovh|pa|page|pamperedchef|panerai|paris|pars|partners|parts|party|passagens|pe|pet|pf|pg|ph|pharmacy|philips|photo|photography|photos|physio|piaget|pics|pictet|pictures|pid|pin|ping|pink|pizza|pk|pl|place|play|playstation|plumbing|plus|pm|pn|pohl|poker|porn|post|pr|praxi|press|pro|prod|productions|prof|promo|properties|property|protection|ps|pt|pub|pw|pwc|py|qa|qpon|quebec|quest|racing|re|read|realtor|realty|recipes|red|redstone|redumbrella|rehab|reise|reisen|reit|ren|rent|rentals|repair|report|republican|rest|restaurant|review|reviews|rexroth|rich|ricoh|rio|rip|ro|rocher|rocks|rodeo|room|rs|rsvp|ru|ruhr|run|rw|rwe|ryukyu|sa|saarland|safe|safety|sakura|sale|salon|samsung|sandvik|sandvikcoromant|sanofi|sap|sapo|sarl|sas|saxo|sb|sbs|sc|sca|scb|schaeffler|schmidt|scholarships|school|schule|schwarz|science|scor|scot|sd|se|seat|security|seek|select|sener|services|seven|sew|sex|sexy|sfr|sg|sh|sharp|shell|shia|shiksha|shoes|show|shriram|si|singles|site|sj|sk|ski|skin|sky|skype|sl|sm|smile|sn|sncf|so|soccer|social|softbank|software|sohu|solar|solutions|song|sony|soy|space|spiegel|spot|spreadbetting|sr|srl|st|stada|star|starhub|statefarm|statoil|stc|stcgroup|stockholm|storage|store|studio|study|style|su|sucks|supplies|supply|support|surf|surgery|suzuki|sv|swatch|swiss|sx|sy|sydney|symantec|systems|sz|tab|taipei|taobao|tatamotors|tatar|tattoo|tax|taxi|tc|tci|td|team|tech|technology|tel|telecity|telefonica|temasek|tennis|tf|tg|th|thd|theater|theatre|tickets|tienda|tiffany|tips|tires|tirol|tj|tk|tl|tm|tmall|tn|to|today|tokyo|tools|top|toray|toshiba|total|tours|town|toyota|toys|tp|tr|trade|trading|training|travel|travelers|travelersinsurance|trust|trv|tt|tube|tui|tunes|tushu|tv|tvs|tw|tz|ua|ubs|ug|uk|unicom|university|uno|uol|us|uy|uz|va|vacations|vana|vc|ve|vegas|ventures|verisign|versicherung|vet|vg|vi|viajes|video|viking|villas|vin|vip|virgin|vision|vista|vistaprint|viva|vlaanderen|vn|vodka|volkswagen|vote|voting|voto|voyage|vu|vuelos|wales|walter|wang|wanggou|watch|watches|weather|weatherchannel|webcam|weber|website|wed|wedding|weir|wf|whoswho|wien|wiki|williamhill|win|windows|wine|wme|wolterskluwer|work|works|world|ws|wtc|wtf|xbox|xerox|xin|xperia|xxx|xyz|yachts|yahoo|yamaxun|yandex|ye|yodobashi|yoga|yokohama|youtube|yt|za|zara|zero|zip|zm|zone|zuerich|zw".split("|"),q="0123456789".split(""),H="0123456789abcdefghijklmnopqrstuvwxyz".split(""),G=[" ","\f","\r","\t","\v"," "," ","᠎"],W=[],J=p(),Q=p(C),K=p(f),Z=p(),Y=p(E);J.on("@",p(g)).on(".",p(v)).on("+",p(x)).on("#",p(k)).on("?",p(A)).on("/",p(M)).on("_",p(j)).on(":",p(b)).on("{",p(R)).on("[",p(_)).on("<",p(O)).on("(",p(U)).on("}",p(D)).on("]",p(N)).on(">",p(F)).on(")",p(L)).on("&",p(B)).on([",",";","!",'"',"'"],p(w)),J.on("\n",p(I)).on(G,Y),Y.on(G,Y);for(var X=0;X<z.length;X++){var ee=o(z[X],J,$,f);W.push.apply(W,ee)}var te=o("file",J,f,f),ne=o("ftp",J,f,f),ie=o("http",J,f,f),se=o("mailto",J,f,f);W.push.apply(W,te),W.push.apply(W,ne),W.push.apply(W,ie);var oe=te.pop(),ae=ne.pop(),re=ie.pop(),le=se.pop(),ce=p(f),de=p(S),ue=p(T);ae.on("s",ce).on(":",de),re.on("s",ce).on(":",de),W.push(ce),oe.on(":",de),ce.on(":",de),le.on(":",ue);var he=o("localhost",J,y,f);W.push.apply(W,he),J.on(q,Q),Q.on("-",Z).on(q,Q).on(H,K),K.on("-",Z).on(H,K);for(var me=0;me<W.length;me++)W[me].on("-",Z).on(H,K);Z.on("-",Z).on(q,K).on(H,K),J.defaultTransition=p(P);function pe(e){for(var t=e.replace(/[A-Z]/g,function(e){return e.toLowerCase()}),n=e.length,i=[],s=0;s<n;){for(var o,a=J,r=null,l=0,c=null,d=-1;s<n&&(r=a.next(t[s]));)(a=r).accepts()?(d=0,c=a):0<=d&&d++,l++,s++;d<0||(s-=d,l-=d,o=c.emit(),i.push(new o(e.substr(s-l,l))))}return i}var fe=Object.freeze({State:u,TOKENS:V,run:pe,start:J}),ge=a();ge.prototype={type:"token",isLink:!1,toString:function(){for(var e=[],t=0;t<this.v.length;t++)e.push(this.v[t].toString());return e.join("")},toHref:function(){return this.toString()},toObject:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"http";return{type:this.type,value:this.toString(),href:this.toHref(e)}}};function be(e){return new h(e)}var ve=t(ge,a(),{type:"email",isLink:!0}),we=t(ge,a(),{type:"email",isLink:!0,toHref:function(){return this.v,"mailto:"+this.toString()}}),ye=t(ge,a(),{type:"text"}),Ie=t(ge,a(),{type:"nl"}),Ce=t(ge,a(),{type:"url",isLink:!0,toHref:function(){for(var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"http",n=!1,i=!1,s=this.v,o=[],a=0;s[a]instanceof S;)n=!0,o.push(s[a].toString().toLowerCase()),a++;for(;s[a]instanceof M;)i=!0,o.push(s[a].toString()),a++;for(;(e=s[a])instanceof f||e instanceof $;)o.push(s[a].toString().toLowerCase()),a++;for(;a<s.length;a++)o.push(s[a].toString());return o=o.join(""),n||i||(o=t+"://"+o),o},hasProtocol:function(){return this.v[0]instanceof S}}),xe=Object.freeze({Base:ge,MAILTOEMAIL:ve,EMAIL:we,NL:Ie,TEXT:ye,URL:Ce}),ke=be(),Se=be(),Te=be(),Ae=be(),Me=be(),je=be(),Pe=be(),$e=be(Ce),Ee=be(),Re=be(Ce),_e=be(Ce),Oe=be(),Ue=be(),De=be(),Ne=be(),Fe=be(),Le=be(Ce),Be=be(Ce),Ve=be(Ce),ze=be(Ce),qe=be(),He=be(),Ge=be(),We=be(),Je=be(),Qe=be(),Ke=be(we),Ze=be(),Ye=be(we),Xe=be(ve),et=be(),tt=be(),nt=be(),it=be(),st=be(Ie);ke.on(I,st).on(S,Se).on(T,Te).on(M,Ae),Se.on(M,Ae),Ae.on(M,Me),ke.on($,je).on(f,je).on(y,$e).on(C,je),Me.on($,_e).on(f,_e).on(C,_e).on(y,_e),je.on(v,Pe),Je.on(v,Qe),Pe.on($,$e).on(f,je).on(C,je).on(y,je),Qe.on($,Ke).on(f,Je).on(C,Je).on(y,Je),$e.on(v,Pe),Ke.on(v,Qe),$e.on(b,Ee).on(M,_e),Ee.on(C,Re),Re.on(M,_e),Ke.on(b,Ze),Ze.on(C,Ye);var ot=[f,g,y,C,x,k,S,M,$,j,P,B],at=[b,v,A,w,D,N,F,L,R,_,O,U];_e.on(R,Ue).on(_,De).on(O,Ne).on(U,Fe),Oe.on(R,Ue).on(_,De).on(O,Ne).on(U,Fe),Ue.on(D,_e),De.on(N,_e),Ne.on(F,_e),Fe.on(L,_e),Le.on(D,_e),Be.on(N,_e),Ve.on(F,_e),ze.on(L,_e),qe.on(D,_e),He.on(N,_e),Ge.on(F,_e),We.on(L,_e),Ue.on(ot,Le),De.on(ot,Be),Ne.on(ot,Ve),Fe.on(ot,ze),Ue.on(at,qe),De.on(at,He),Ne.on(at,Ge),Fe.on(at,We),Le.on(ot,Le),Be.on(ot,Be),Ve.on(ot,Ve),ze.on(ot,ze),Le.on(at,Le),Be.on(at,Be),Ve.on(at,Ve),ze.on(at,ze),qe.on(ot,Le),He.on(ot,Be),Ge.on(ot,Ve),We.on(ot,ze),qe.on(at,qe),He.on(at,He),Ge.on(at,Ge),We.on(at,We),_e.on(ot,_e),Oe.on(ot,_e),_e.on(at,Oe),Oe.on(at,Oe),Te.on($,Xe).on(f,Xe).on(C,Xe).on(y,Xe),Xe.on(ot,Xe).on(at,et),et.on(ot,Xe).on(at,et);var rt=[f,C,x,k,A,j,P,B,$];je.on(rt,tt).on(g,nt),$e.on(rt,tt).on(g,nt),Pe.on(rt,tt),tt.on(rt,tt).on(g,nt).on(v,it),it.on(rt,tt),nt.on($,Je).on(f,Je).on(y,Ke);function lt(e){for(var t=e.length,n=0,i=[],s=[];n<t;){for(var o=ke,a=null,r=null,l=0,c=null,d=-1;n<t&&!(a=o.next(e[n]));)s.push(e[n++]);for(;n<t&&(r=a||o.next(e[n]));)a=null,(o=r).accepts()?(d=0,c=o):0<=d&&d++,n++,l++;if(d<0)for(var u=n-l;u<n;u++)s.push(e[u]);else{0<s.length&&(i.push(new ye(s)),s=[]),n-=d,l-=d;var h=c.emit();i.push(new h(e.slice(n-l,n)))}}return 0<s.length&&i.push(new ye(s)),i}var ct=Object.freeze({State:h,TOKENS:xe,run:lt,start:ke});Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)});function dt(e){return lt(pe(e))}e.find=function(e){for(var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=dt(e),i=[],s=0;s<n.length;s++){var o=n[s];!o.isLink||t&&o.type!==t||i.push(o.toObject())}return i},e.inherits=t,e.options=c,e.parser=ct,e.scanner=fe,e.test=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=dt(e);return 1===n.length&&n[0].isLink&&(!t||n[0].type===t)},e.tokenize=dt}(self.linkify=self.linkify||{})}(),function(e){var t=function(f){function n(e){this.a=e}function t(e){return d.test(e)}function i(e){return u.test(e)}function s(e,t){this.b=e,this.c=t,this.d=null,this.input=null,this.e=-1,this.f=-1,this.g=-1,this.h=-1,this.i=-1,this.j()}function o(e,t){this.k=null,this.startLine=1,this.startColumn=0,this.options=t||{},this.tokenizer=new s(this,e)}var a={m:" "},r=/^#[xX]([A-Fa-f0-9]+)$/,l=/^#([0-9]+)$/,c=/^([A-Za-z0-9]+)$/;n.prototype.parse=function(e){if(e){var t=e.match(r);return t?"&#x"+t[1]+";":(t=e.match(l))?"&#"+t[1]+";":(t=e.match(c))?this.a[t[1]]||"&"+t[1]+";":void 0}};var d=/[\t\n\f ]/,u=/[A-Za-z]/,h=/\r\n?/g;s.prototype={j:function(){this.d="beforeData",this.input="",this.e=0,this.f=1,this.g=0,this.h=-1,this.i=-1,this.b.j()},tokenize:function(e){this.j(),this.tokenizePart(e),this.tokenizeEOF()},tokenizePart:function(e){for(this.input+=e.replace(h,"\n");this.e<this.input.length;)this.n[this.d].call(this)},tokenizeEOF:function(){this.o()},o:function(){"data"===this.d&&(this.b.p(),this.d="beforeData")},q:function(){return this.input.charAt(this.e)},r:function(){var e=this.q();return this.e++,"\n"===e?(this.f++,this.g=0):this.g++,e},s:function(){var e=this.input.indexOf(";",this.e);if(-1!==e){var t=this.input.slice(this.e,e),n=this.c.parse(t);if(n){for(var i=t.length;i;)this.r(),i--;return this.r(),n}}},t:function(){this.h=this.f,this.i=this.g,this.b.tagOpen&&this.b.tagOpen()},n:{beforeData:function(){"<"===this.q()?(this.d="tagOpen",this.t(),this.r()):(this.d="data",this.b.u())},data:function(){var e=this.q();"<"===e?(this.b.p(),this.d="tagOpen",this.t(),this.r()):"&"===e?(this.r(),this.b.v(this.s()||"&")):(this.r(),this.b.v(e))},tagOpen:function(){var e=this.r();"!"===e?this.d="markupDeclaration":"/"===e?this.d="endTagOpen":i(e)&&(this.d="tagName",this.b.w(),this.b.x(e.toLowerCase()))},markupDeclaration:function(){"-"===this.r()&&"-"===this.input.charAt(this.e)&&(this.r(),this.d="commentStart",this.b.y())},commentStart:function(){var e=this.r();"-"===e?this.d="commentStartDash":">"===e?(this.b.z(),this.d="beforeData"):(this.b.A(e),this.d="comment")},commentStartDash:function(){var e=this.r();"-"===e?this.d="commentEnd":">"===e?(this.b.z(),this.d="beforeData"):(this.b.A("-"),this.d="comment")},comment:function(){var e=this.r();"-"===e?this.d="commentEndDash":this.b.A(e)},commentEndDash:function(){var e=this.r();"-"===e?this.d="commentEnd":(this.b.A("-"+e),this.d="comment")},commentEnd:function(){var e=this.r();">"===e?(this.b.z(),this.d="beforeData"):(this.b.A("--"+e),this.d="comment")},tagName:function(){var e=this.r();t(e)?this.d="beforeAttributeName":"/"===e?this.d="selfClosingStartTag":">"===e?(this.b.B(),this.d="beforeData"):this.b.x(e)},beforeAttributeName:function(){var e=this.q();return t(e)?void this.r():void("/"===e?(this.d="selfClosingStartTag",this.r()):">"===e?(this.r(),this.b.B(),this.d="beforeData"):(this.d="attributeName",this.b.C(),this.r(),this.b.D(e)))},attributeName:function(){var e=this.q();t(e)?(this.d="afterAttributeName",this.r()):"/"===e?(this.b.F(!1),this.b.G(),this.r(),this.d="selfClosingStartTag"):"="===e?(this.d="beforeAttributeValue",this.r()):">"===e?(this.b.F(!1),this.b.G(),this.r(),this.b.B(),this.d="beforeData"):(this.r(),this.b.D(e))},afterAttributeName:function(){var e=this.q();return t(e)?void this.r():void("/"===e?(this.b.F(!1),this.b.G(),this.r(),this.d="selfClosingStartTag"):"="===e?(this.r(),this.d="beforeAttributeValue"):">"===e?(this.b.F(!1),this.b.G(),this.r(),this.b.B(),this.d="beforeData"):(this.b.F(!1),this.b.G(),this.r(),this.d="attributeName",this.b.C(),this.b.D(e)))},beforeAttributeValue:function(){var e=this.q();t(e)?this.r():'"'===e?(this.d="attributeValueDoubleQuoted",this.b.F(!0),this.r()):"'"===e?(this.d="attributeValueSingleQuoted",this.b.F(!0),this.r()):">"===e?(this.b.F(!1),this.b.G(),this.r(),this.b.B(),this.d="beforeData"):(this.d="attributeValueUnquoted",this.b.F(!1),this.r(),this.b.H(e))},attributeValueDoubleQuoted:function(){var e=this.r();'"'===e?(this.b.G(),this.d="afterAttributeValueQuoted"):"&"===e?this.b.H(this.s('"')||"&"):this.b.H(e)},attributeValueSingleQuoted:function(){var e=this.r();"'"===e?(this.b.G(),this.d="afterAttributeValueQuoted"):"&"===e?this.b.H(this.s("'")||"&"):this.b.H(e)},attributeValueUnquoted:function(){var e=this.q();t(e)?(this.b.G(),this.r(),this.d="beforeAttributeName"):"&"===e?(this.r(),this.b.H(this.s(">")||"&")):">"===e?(this.b.G(),this.r(),this.b.B(),this.d="beforeData"):(this.r(),this.b.H(e))},afterAttributeValueQuoted:function(){var e=this.q();t(e)?(this.r(),this.d="beforeAttributeName"):"/"===e?(this.r(),this.d="selfClosingStartTag"):">"===e?(this.r(),this.b.B(),this.d="beforeData"):this.d="beforeAttributeName"},selfClosingStartTag:function(){">"===this.q()?(this.r(),this.b.I(),this.b.B(),this.d="beforeData"):this.d="beforeAttributeName"},endTagOpen:function(){var e=this.r();i(e)&&(this.d="tagName",this.b.J(),this.b.x(e.toLowerCase()))}}},o.prototype={tokenize:function(e){return this.K=[],this.tokenizer.tokenize(e),this.K},tokenizePart:function(e){return this.K=[],this.tokenizer.tokenizePart(e),this.K},tokenizeEOF:function(){return this.K=[],this.tokenizer.tokenizeEOF(),this.K[0]},j:function(){this.k=null,this.startLine=1,this.startColumn=0},L:function(){this.options.M&&(this.k.M={start:{f:this.startLine,g:this.startColumn},N:{f:this.tokenizer.f,g:this.tokenizer.g}}),this.startLine=this.tokenizer.f,this.startColumn=this.tokenizer.g},u:function(){this.k={type:"Chars",chars:""},this.K.push(this.k)},v:function(e){this.k.chars+=e},p:function(){this.L()},y:function(){this.k={type:"Comment",chars:""},this.K.push(this.k)},A:function(e){this.k.chars+=e},z:function(){this.L()},w:function(){this.k={type:"StartTag",tagName:"",attributes:[],l:!1},this.K.push(this.k)},J:function(){this.k={type:"EndTag",tagName:""},this.K.push(this.k)},B:function(){this.L()},I:function(){this.k.l=!0},x:function(e){this.k.tagName+=e},C:function(){this._currentAttribute=["","",null],this.k.attributes.push(this._currentAttribute)},D:function(e){this._currentAttribute[0]+=e},F:function(e){this._currentAttribute[2]=e},H:function(e){this._currentAttribute[1]=this._currentAttribute[1]||"",this._currentAttribute[1]+=e},G:function(){}};var m={HTML5NamedCharRefs:a,EntityParser:n,EventedTokenizer:s,Tokenizer:o,tokenize:function(e,t){return new o(new n(a),t).tokenize(e)}},p=f.options,g=p.Options,b="StartTag",v="EndTag",w="Chars";return function(e){for(var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=m.tokenize(e),i=[],s=[],t=new g(t),o=0;o<n.length;o++){var a,r=n[o];if(r.type!==b){r.type===w?(a=function(e,t){for(var n=f.tokenize(e),i=[],s=0;s<n.length;s++){var o=n[s];if("nl"===o.type&&t.nl2br)i.push({type:b,tagName:"br",attributes:[],l:!0});else if(o.isLink&&t.check(o)){var a,r=t.resolve(o),l=(r.href,r.formatted),c=r.formattedHref,d=r.tagName,u=r.className,h=r.target,m=r.attributes,p=[["href",c]];for(a in u&&p.push(["class",u]),h&&p.push(["target",h]),m)p.push([a,m[a]]);i.push({type:b,tagName:d,attributes:p,l:!1}),i.push({type:w,chars:l}),i.push({type:v,tagName:d})}else i.push({type:w,chars:o.toString()})}return i}(r.chars,t),i.push.apply(i,a)):i.push(r)}else{i.push(r);var l=r.tagName.toUpperCase();if(!("A"===l||p.contains(t.ignoreTags,l)))continue;var c=i.length;(function(e,t,n,i){for(var s=1;n<t.length&&0<s;){var o=t[n];o.type===b&&o.tagName.toUpperCase()===e?s++:o.type===v&&o.tagName.toUpperCase()===e&&s--,i.push(o),n++}})(l,n,++o,i),o+=i.length-c-1}}for(o=0;o<i.length;o++){var d=i[o];switch(d.type){case b:var u="<"+d.tagName;0<d.attributes.length&&(u+=" "+function(e){for(var t=[],n=0;n<e.length;n++){var i=e[n],s=i[0],o=i[1];t.push(s+'="'+o.replace(/"/g,"&quot;")+'"')}return t}(d.attributes).join(" ")),u+=">",s.push(u);break;case v:s.push("</"+d.tagName+">");break;case w:s.push(d.chars);break;case"Comment":s.push("\x3c!--"+d.chars+"--\x3e")}}return s.join("")}}(linkify);e.linkifyHtml=t}(window),Ibles.package("Ibles.views"),Ibles.views.RedactorTextAreaView=Backbone.View.extend({initialize:function(e){_.bindAll(this,"redactorLoaded","sync"),e=e||{},this.enableHtml=e.enableHtml||!1,this.textArea=e.textArea||this.$(".redactor-textarea"),this.toolTip=e.tooltip||this.$(".redactor-tooltip"),this.redactorOptions=e.redactorOptions||{},this.addAirOptions(),this.enableHtml&&this.addHtmlOptions(),this.redactorLoadedCallback=e.redactorLoadedCallback,this.addRedactorAirMode()},addAirOptions:function(){this.redactorOptions=_.extend(this.redactorOptions,{air:!0,plugins:["instructables","instructablesAir"],airButtons:["bold","italic","heading","link_ibles","quote"],convertVideoLinks:!0,convertLinks:!0,buttonsCustom:{link_ibles:{title:"Link",callback:function(e){this.ibles_makeLink(e)}},heading:{title:"Heading",callback:function(e){this.ibles_makeheader(e)}},quote:{title:"Blockquote",func:"formatQuote"}}})},addHtmlOptions:function(){this.redactorOptions=_.extend(this.redactorOptions,{airButtons:["bold","italic","heading","link_ibles","quote","html"],convertDivs:!1,deniedTags:[],syncBeforeCallback:function(e){return!0===this.editedCode?this.get():e},textareaKeydownCallback:function(){this.editedCode=!0},keydownCallback:function(){this.editedCode=!1}})},addRedactorAirMode:function(){var e=this,t=Ibles.pageContext.commitInfo&&Ibles.pageContext.commitInfo.git_hash||"",n=_.map(["editor/desktop/dependencies/redactor916/redactor/redactor.css","editor/desktop/dependencies/redactorInstructables/airmode.css","editor/desktop/dependencies/redactor916/redactor/redactor.min.js","js/RedactorAirPlugin.js"],function(e){return"{0}{1}{2}".format(Ibles.pageContext.staticRoot,e,"?cb={0}".format(t))});head.load(n,function(){e.textArea.redactor(e.redactorOptions||{}),e.redactorLoaded()})},redactorLoaded:function(){this.trigger("redactorLoaded"),"function"==typeof this.redactorLoadedCallback&&this.redactorLoadedCallback()},sync:function(){return this.textArea.redactor("sync"),this.textArea.redactor("get")},hideToolTip:function(){this.toolTip.tooltip("hide"),this.$(".redactor_redactor-textarea").off("click")},reset:function(){this.$(".redactor_editor").empty(),this.textArea.val("")}}),Ibles.package("Ibles.views"),Ibles.views.ScrollableCardsView=Backbone.View.fullExtend({events:{"click .left-control":"scrollBack","click .right-control":"scrollForward"},initialize:function(){_.bindAll(this,"scroll"),this.$scrollable=this.$(".scrollable-cards-inner"),this.$scrollable.scroll(_.debounce(this.scroll,250))},scrollBack:function(e){var t;e.preventDefault(),$(e.currentTarget).hasClass("active")&&(t=this.$(".carousel-items").scrollLeft(),this.$scrollable.animate({scrollLeft:t-this.$scrollable.width()},800))},scrollForward:function(e){var t;e.preventDefault(),$(e.currentTarget).hasClass("active")&&(t=this.$scrollable.scrollLeft(),this.$scrollable.animate({scrollLeft:t+this.$scrollable.width()},800))},scroll:function(){var e=this.$scrollable,t=this.$(".right-control"),n=this.$(".left-control"),i=e.children(".scrollable-card").last(),s=e.width();0<e.scrollLeft()?n.addClass("active"):n.removeClass("active"),i.position().left+i.width()<=s?t.removeClass("active"):t.addClass("active")}}),Ibles.package("Ibles.models"),Ibles.models.CommentModel=Backbone.Model.extend({defaults:function(){return{id:null,instructableId:null,topicId:null,author:Ibles.session.get("screenName"),authorId:Ibles.session.get("id"),authorUrl:null,avatar:Ibles.session.getAvatarUrl(),avatarDownload:null,files:[],fileSet:new Ibles.collections.FileCollection,IMadeIt:!1,inReplyTo:null,replyAuthor:null,quarantine:!1,limbo:!1,status:null,commentable:null,commentableId:null,body:"",stepId:null,stepAnchorId:null,stepIndexLabel:null,designations:[],voted:!1,rating:0,sticky:!1,visible:!0,lastVisibleInThread:!1,indexInReplyThread:null,numRepliesFromMe:null}},designations:["tip","topic","review","answer","bestAnswer","comment","question"],initialize:function(){_.bindAll(this,"onSaveError","onSaveSuccess","onEditSuccess","onDeleteSuccess"),_.isUndefined(this.get("publishDate"))||this.set({commentTime:moment(Ibles.addServerTimeZone(this.get("publishDate"))).fromNow()}),_.isEmpty(this.get("authorUrl"))&&this.set({authorUrl:Ibles.reverseUrls.memberUrl(this.get("author"))}),_.isEmpty(this.get("files"))||this.get("fileSet").add(this.get("files")),"DELETED"===this.get("status")&&this.setDeletedBody(),window.linkify&&(window.linkify.options.defaults.className=null),this.listenTo(this,"change:body",function(){this.set({body:linkifyHtml(this.get("body"))},{silent:!0})}),this.listenTo(this,"change:designations",function(){this.updateDesignatedProps()}),this.updateDesignatedProps()},updateDesignatedProps:function(){this.set({designatedQuestion:this.isQuestion(),designatedTip:this.isTip(),designatedAnswer:this.isAnswer(),designatedBestAnswer:this.isBestAnswer(),designatedComment:this.isDesignatedComment()})},isReply:function(){return!!this.get("inReplyTo")},isVisible:function(){return this.get("visible")},hasDesignation:function(){return!_.isEmpty(this.get("designations"))},hasChildren:function(){var e=this.collection,t=e&&e.at(e.indexOf(this)+1);return t&&t.get("inReplyTo")==this.get("id")},isDesignated:function(e){return _.contains(this.get("designations"),e)},isQuestion:function(){return this.isDesignated("question")},isAnswer:function(){return this.isDesignated("answer")},isBestAnswer:function(){return this.isDesignated("bestAnswer")},isTip:function(){return this.isDesignated("tip")},isDesignatedComment:function(){return this.isDesignated("comment")},isIMadeIt:function(){return this.get("IMadeIt")},voted:function(){return!!this.get("voted")},votes:function(){return this.get("rating")},votableByCurrentUser:function(){var e=Ibles.session,t=e.get("screenName"),n=this.get("author");return e.authenticated()&&t!=n},currentUserIsOwner:function(){return this.currentUserIsAuthor()},currentUserIsAuthor:function(){var e=Ibles.session,t=e.get("screenName"),n=this.get("author");return e.authenticated()&&t==n},authorIsProjectOwner:function(e){var t=e.get("author");return _.isObject(t)&&(t=t.screenName),this.get("author")===t},getAuthorAvatarUrl:function(){var e=this.get("avatarDownload");return e?Ibles.fileFromOriginalUrl(e,{isUserFile:!0}).getTinyUrl():Ibles.session.getAvatarUrl()},setDesignations:function(e,t){var n={commentId:this.get("id"),designations:e},i=this;return t&&(n.threadDesignations=t),Ibles.API.jsonPostRequest("setDesignations",n).done(function(){i.set({designations:e})})},setDeletedBody:function(){this.set({body:Ibles.T("(removed by author or community request)")})},setReplyAuthor:function(){var e,t=this,n=t.collection;n&&!_.isUndefined(t.get("inReplyTo"))&&_.isNull(t.get("replyAuthor"))&&(e=n.get(t.get("inReplyTo")),_.isEmpty(e)||t.set({replyAuthor:e.get("author")}))},getImagesParam:function(){var e=this.get("fileSet"),t=[];return e.isEmpty()||(t=_.isFunction(e.idArray)?e.idArray():e.map(function(e){return{id:e.get("id")}})),t},editRequest:function(){var e=this,t={id:e.get("id"),body:e.get("body"),images:e.getImagesParam()};return Ibles.API.jsonPostRequest("editComment",t,{success:e.onEditSuccess,error:e.onSaveError})},onEditSuccess:function(){this.trigger("change"),this.trigger("comment.postSuccess",this)},save:function(){var e=_.omit(_.pick(this.toJSON(),"instructableId","topicId","author","IMadeIt","body","inReplyTo","stepId","designations"),_.isNull);return e.images=this.getImagesParam(),Ibles.API.jsonPostRequest("addComment",e,{success:this.onSaveSuccess,error:this.onSaveError},"id")},onSaveSuccess:function(e){var t,n=this,i=n.collection;n.set({id:e.id,commentTime:"a few seconds ago",publishDate:moment().fromNow()}),n.trigger("comment.postSuccess",n),_.isUndefined(n.get("inReplyTo"))?i.add(n,{at:0}):(t=i.indexOf(i.findWhere({id:n.get("inReplyTo")})),i.add(n,{at:t+1}),i.dirtyTree=!0)},onSaveError:function(e){var t,n;e&&e.responseJSON&&(e=e.responseJSON),n=e&&e.validationErrors?1<(t=Object.keys(e.validationErrors)).length?Ibles.text.errors.incompleteFormError:e.validationErrors[t[0]]:Ibles.extractErrorMessage(e,Ibles.text.errors.somethingWentWrong),this.trigger("comment.postError",n)},toggleVote:function(){var t=this,e={commentId:t.get("id")},n=t.get("voted");return e.value=n?0:1,Ibles.API.jsonPostRequest("addRating",e,{success:function(){var e=t.get("rating");n=!n,t.set({voted:n,rating:n?++e:--e})}})},toggleBestAnswer:function(){var e=this,t=e.isBestAnswer()?["answer"]:["answer","bestAnswer"];return Ibles.API.jsonPostRequest("setDesignations",{commentId:e.get("id"),designations:t}).done(function(){e.set({designations:t})})},deleteComment:function(){return Ibles.API.postRequest("deleteComment",{id:this.get("id")},{success:this.onDeleteSuccess})},onDeleteSuccess:function(){var e=this;0<e.collection.getChildrenArray(e).length?e.setDeletedBody():e.collection.remove(e)},deleteThread:function(){var e=this;return Ibles.API.postRequest("deleteThread",{id:this.get("id")},{success:function(){e.collection.deleteThread(e)}})},setIMadeIt:function(e){var t={id:this.get("id"),value:e};return $.ajax({url:"/json-api/setIMadeIt",dataType:"json",type:"POST",data:t})},flagComment:function(e){var t={id:this.get("id"),flag:e};return Ibles.API.postRequest("setFlag",t)},limbo:function(){var e=this;return Ibles.API.jsonPostRequest("adminComment",{id:this.get("id"),status:"LIMBO"}).done(function(){e.set({limbo:!0,quarantined:!1,status:"LIMBO"})})},quarantine:function(){var e=this;return Ibles.API.jsonPostRequest("adminComment",{id:this.get("id"),status:"QUARANTINED"}).done(function(){e.set({quarantine:!0,limbo:!1,status:"QUARANTINED"})})},publish:function(){var e=this;return Ibles.API.jsonPostRequest("adminComment",{id:this.get("id"),status:"PUBLISHED"}).done(function(){e.set({limbo:!1,quarantine:!1,status:"PUBLISHED"})})},toggleStickyComment:function(e){var t=this;return Ibles.API.jsonPostRequest("adminComment",{id:this.get("id"),sticky:e}).done(function(){t.set({sticky:e})})},toggleApproval:function(e){var t=this;return Ibles.API.jsonPostRequest("adminComment",{id:this.get("id"),approved:e}).done(function(){t.set({approved:e})})},cloneWithoutUserSuppliedData:function(){var e=this.clone();return e.set({id:null,fileSet:new Ibles.collections.FileCollection,IMadeIt:!1,body:""}),e},toJSON:function(){var e=this;return _.extend(_.clone(e.attributes),{isTip:e.isTip(),isQuestion:e.isQuestion(),isAnswer:e.isAnswer(),isBestAnswer:e.isBestAnswer(),isReply:e.isReply(),avatar:e.getAuthorAvatarUrl()})}}),function(r){r.package("Ibles.collections"),r.collections.CommentCollection=Backbone.Collection.extend({model:r.models.CommentModel,dirtyTree:!1,apiEndPoint:"getComments",defaultFetchParams:{offset:0,limit:50,sort:"RECENT"},fetchOptions:["limit","offset","sort","instructableId","topicId","commentId","designation","IMadeIt"],additionOptions:["modelOptions","ratingOptions","numVisibleReplies","fetchRatings"],initialize:function(e,t){var n=t||{},i=this.fetchOptions;this.options=_.pick(n,i.concat(this.additionOptions)),this.fetchParams=_.extend(_.clone(this.defaultFetchParams),_.omit(_.pick(n,i,_.isUndefined))),this.modelProps=_.pick(n,n.modelOptions),n.fetchRatings&&r.session.isEmailVerified()&&(this.userRatingsPromise=this.fetchUserRatings())},deleteThread:function(e){var t=this.getChildrenArray(e),n=this.getParents(e);this.remove(t),this.remove(e),this.remove(n)},getLastThreadInfo:function(){var e=this,t=e.length,n=e.reloadingTree||!t,i=n?-1:_.findLastIndex(e.models,function(e){return!e.get("inReplyTo")}),s=-1!==(s=n?-1:_.findLastIndex(e.models.slice(i),function(e){return e.get("lastVisibleInThread")}))?s+i:-1;return{lastComment:n?null:e.models[t-1],lastVisibleInThread:0<=s?e.at(s):null,repliesCount:n||-1===i?0:t-i-1}},parseComments:function(e){var n=this,i=n.options.numVisibleReplies,s=_.isNumber(i),t=s?n.getLastThreadInfo():{},o=t.lastVisibleInThread,a=t.lastComment,r=t.repliesCount,l=e.comments,c=n.userRatingsPromise;return l.forEach(function(t){_.extend(t,this.modelProps),_.isUndefined(t.author)&&(t.author=null,t.authorUrl="/"),c&&c.done(function(e){t.voted=!!e[t.id]}),s&&(_.extend(t,{visible:!0,lastVisibleInThread:!1}),t.inReplyTo?i<(r+=1)&&(t.visible=!1,a&&n.isVisible(a)&&(n.setLastVisibleInThread(a,r),o=a)):(o&&(n.setNumberOfRepliesFromComment(o,r),o=null),r=0)),a=t},this),s&&o&&n.setNumberOfRepliesFromComment(o,r),l},isVisible:function(e){return e.visible||e.cid&&e.get("visible")},setLastVisibleInThread:function(e,t){var n=t-1;e.cid?e.set({lastVisibleInThread:!0,indexInReplyThread:n},{silent:!0}):(e.lastVisibleInThread=!0,e.indexInReplyThread=n)},setNumberOfRepliesFromComment:function(e,t){var n;e.cid?(n=e.get("inReplyTo")?t-1-e.get("indexInReplyThread"):t,e.set({numRepliesFromMe:n})):(n=e.inReplyTo?t-1-e.indexInReplyThread:t,e.numRepliesFromMe=n)},fetch:function(e){var t=this;return this.dirtyTree?this.reloadCommentTree():this.fetchRequest(_.extend({offset:this.fetchParams.offset+this.length},e),function(e){t.add(e),e.length<t.fetchParams.limit&&t.trigger("noMoreComments")})},fetchRequest:function(e,t){function n(){return r.API.getRequest(a,_.extend({},s,e),{success:function(e){t(i.parseComments(e))}})}var i=this,s=i.fetchParams,o=i.userRatingsPromise,a=i.apiEndPoint;return o?o.then(n):n()},reloadCommentTree:function(){var t=this,n=this.length+this.fetchParams.limit;return this.reloadingTree=!0,this.dirtyTree=!1,this.fetchRequest({offset:0,limit:n},function(e){t.reset(e),e.length<n&&t.trigger("noMoreComments"),t.reloadingTree=!1})},getParents:function(e){var n=this,i=[],s=function(e){var t=e.get("inReplyTo");if(_.isUndefined(t))return i;i.push(t),_.isUndefined(n.get(t))||s(n.get(t))};return s(e)},getChildrenArray:function(e){var n=this,i=[],s=function(e){var t=n.where({inReplyTo:e.get("id")});0<t.length&&(i=i.concat(_.pluck(t,"id")),_.each(t,s))};return s(e),i},getRatingsParams:function(){var e=this.options;return _.extend({screenName:r.session.get("screenName")},_.pick(e,e.ratingOptions))},fetchUserRatings:function(){var n,e,t,i=r.commentRatingsPromises,s=this.getRatingsParams();return _.isUndefined(i)&&(r.commentRatingsPromises=i={}),t=i[e=_.flatten(_.pairs(s)).join("-")],_.isEmpty(t)?(n=$.Deferred(),r.API.getRequest("getRatings",s).then(function(e){var t={};_.each(e.ratings,function(e){t[e.id]=!0}),n.resolve(t)}),i[e]=n.promise()):t}})}(Ibles),function(a){a.package("Ibles.views"),a.views.BaseCommentView=Backbone.View.extend({photosSelector:".js-photos",attachmentsSelector:".js-attachments",bodySelector:".js-body",htmlPreRendered:!1,showPhotos:!0,showAttachments:!0,upvotingEnabled:!0,replyEnabled:!0,lazyImage:!0,manager:null,imageTemplate:null,fileTemplate:_.template(a.JST["comment-attached-file"]),template:_.template(a.JST["comment-item"]),showRepliesTemplate:_.template(a.JST["comment-hidden-replies-toggler"]),authorOptsTemplate:_.template(a.JST["comment-author-opts"]),events:{"click .js-reply":"onClickReply","click .js-reply-parent":"scrollToParent","click .js-vote-btn, .js-vote-count":"toggleVote","click .js-show-replies":"showRemainingRepliesInThread","click .js-toggle-best-answer":"toggleBestAnswer","click .js-del-comment":"deleteComment","click .js-del-thread":"deleteThread"},initialize:function(e){var t=this;_.extend(t,_.pick(e,["manager","htmlPreRendered","showPhotos","showAttachments","upvotingEnabled","replyEnabled","lazyImage"])),!t.model&&t.htmlPreRendered&&(t.model=t.makeCommentModelFromEl(),t.collection.add(t.model)),t.listenTo(t.model,"change:numRepliesFromMe",t.updateNumRepliesFromMe),t.listenTo(t.model,"change:visible",t.toggleVisibility),t.listenTo(t.model,"remove",t.remove)},makeCommentModelFromEl:function(){var e=this.$el,t=this.manager,n=e.data(),i=e.find(".js-show-replies"),s=!!i.length,o=s?i.data("num-hidden"):null;return new a.models.CommentModel({id:n.id,stepId:n.stepid,inReplyTo:n.inreplyto,body:e.find(".text").text(),author:e.find(".user").text(),authorId:n.authorid,approved:!!n.approved,visible:!e.hasClass("hide"),lastVisibleInThread:s,numRepliesFromMe:o,instructableId:t.model.get("id")},{collection:this.collection})},getTemplateContext:function(){var e=this,t=e.model,n=e.manager.additionalCommentContext;return _.extend(e.model.toJSON(),{upvotingEnabled:e.upvotingEnabled,replyEnabled:e.replyEnabled,lazyImage:e.lazyImage,hasChildren:t.hasChildren()},n?n(t):{})},afterFilesRendered:function(){},scrollToParent:function(e){e.preventDefault(),this.manager.scrollToComment(this.model.get("inReplyTo"))},toggleVisibility:function(){this.$el[this.model.get("visible")?"removeClass":"addClass"]("hide")},showRemainingRepliesInThread:function(){var e=this.model;this.$(".js-show-replies").hide(),this.manager.showRepliesStartingFromModel(this.model),e.set({lastVisibleInThread:!1},{silent:!0})},updateNumRepliesFromMe:function(){var e,t,n=this,i=n.showRepliesTemplate,s=n.model.get("numRepliesFromMe"),o=n.$(".js-show-replies"),a=i({replyCountlabel:n.getReplyCountLabel(s)});o.length?o.replaceWith(a):(e=[n.attachmentsSelector,n.photosSelector,n.bodySelector],_.find(e,function(e){return!!(t=n.$(e)).length}),t.after(a))},getReplyCountLabel:function(e){var t=this.model.isQuestion()?"{0} answer{0}".format(e,1<e?"s":""):"{0} {1}".format(e,1<e?"replies":"reply");return t},render:function(){var e,t=this,n=t.$el;return t.model.setReplyAuthor(),t.htmlPreRendered||(e=t.getTemplateContext(),t.setElement(t.template(e)),n[0].parentNode&&n.replaceWith(t.$el)),t.renderAuthorIndicator(),t.showVoting(),t.showBestAnswerToggle(),t.renderFiles(),this},renderFiles:function(){this.renderPhotos(),this.renderAttachments(),this.afterFilesRendered()},renderPhotos:function(){var t,n,i,e,s=this;s.showPhotos&&(t=s.model,n=s.imageTemplate,i=s.$(s.photosSelector),e=t.get("fileSet").getImages(),_.each(e,function(e){i.append(n(_.extend(e.toJSON(),{commentId:t.get("id"),imageLink:e.getLargeAnimationUrl(),imageSrc:a.isMobile()?e.getSquareAnimationUrl():e.getSquare3AnimationUrl(),lazyImage:s.lazyImage})))}))},renderAttachments:function(){var t,n,i,e,s=this;s.showAttachments&&(t=s.model,n=s.fileTemplate,i=s.$(s.attachmentsSelector),e=t.get("fileSet").getAttachments(),_.each(e,function(e){i.append(n(_.extend(e.toJSON(),{commentId:t.get("id"),typeThumbnail:e.getTypeThumbnailUrl(),attachmentUrl:e.getDownloadUrl()})))}))},renderAuthorIndicator:function(){var e,t=this.model,n=this.manager,i=this.$(".author");i.hasClass("owner")||(e=n.model.get("author"),_.isObject(e)&&(e=e.screenName),t.get("author")===e&&i.addClass("owner"))},onClickReply:function(e){e.preventDefault();var t=this;a.requireLogin(function(){t.renderReplyView($(e.target),t.createReplyPostingView(t.model))},{sourcea:"comments:reply"})},createReplyPostingView:function(e){return this.manager.makeReplyPostingView(e)},renderReplyView:function(e,t,n){var i,s,o;e.hide(),t.render(),this.$el.append(t.$el),n&&(i=a.isMobile()?$(".modal.in"):$(".modal-container"),o=i.length?(s=i,t.$el.offset().top-s.offset().top+s.scrollTop()):(s=$("html, body"),t.$el.offset().top),_.delay(function(){s.animate({scrollTop:o},1e3)},250)),this.listenToOnce(t,"posted destroyed",function(){e.show()})},showVoting:function(){var e=this.model;e.currentUserIsAuthor()?this.$(".js-vote").addClass("hide"):e.votableByCurrentUser()&&e.voted()&&this.$(".js-vote-btn").text("Upvoted").addClass("voted")},toggleVote:function(){var e=this,t=e.model;a.requireEmailVerification(function(){t.votableByCurrentUser()&&t.toggleVote().done(function(){e.$(".js-vote-count").text(t.votes()).removeClass("hide"),e.$(".js-vote-btn").text(t.voted()?"Upvoted":"Upvote").toggleClass("voted")})},{sourcea:"upvote"})},showBestAnswerToggle:function(){(this.manager.model.currentUserIsOwner()||a.session.isAdmin())&&this.$(".js-toggle-best-answer").removeClass("hide")},toggleBestAnswer:function(){var e=this,t=e.model;t.toggleBestAnswer().done(function(){e.$(".js-toggle-best-answer").html(t.isBestAnswer()?"Undo Best Answer":"Select as Best Answer")})},deleteComment:function(){new a.views.CommentDeletePrompt({model:this.model,title:"Delete Comment",deleteThread:!1}).render()},deleteThread:function(){new a.views.CommentDeletePrompt({model:this.model,title:"Delete Comment Thread",deleteThread:!0}).render()},destroy:function(){this.stopListening(),this.undelegateEvents(),this.$el.removeData().unbind(),this.manager=null,this.model=null,this.collection=null}})}((window,document,Ibles)),function(e,a){a.package("Ibles.views"),a.views.CommentTypeSelector=Backbone.View.extend({template:_.template(a.JST["comment-posting-view"]),events:{"click .js-type-tip":"renderTipPoster","click .js-type-question":"renderQuestionPoster","click .js-type-comment":"renderCommentPoster"},initialize:function(e){_.extend(this,_.pick(e,["manager"]))},scrollToMe:function(){e.location="#discuss"},renderPoster:function(n){var i=this,s=i.manager,o=n.modelProps;a.requireLogin(function(){var e=new a.views.CommentPostingView({model:s.makeCommentModel(o||{})}),t=n.callback;i.$el.html(e.render().$el),i.listenToOnce(e,"posted destroyed",function(){i.render()}),t&&t()},{sourcea:"comments:selecttype"})},renderPosterForType:function(e){this.renderPoster({modelProps:{designations:[e]}})},renderTipPoster:function(){this.renderPosterForType("tip")},renderQuestionPoster:function(){this.renderPosterForType("question")},renderCommentPoster:function(){this.renderPosterForType("comment")},render:function(){return this.$el.html(this.template({commentBody:"",submitLabel:"Post",isEdit:!1,isIMadeIt:!1,typeSelected:!1,isMobile:a.isMobile(),avatar:a.session.getAvatarUrl()})),this}})}(window,Ibles),function(e,s){s.package("Ibles.views"),s.views.CommentPostingView=Backbone.View.extend({template:_.template(s.JST["comment-posting-view"]),skipUploaderModal:!1,hideOnBlur:!0,recreateOnPost:!1,submitLabel:"",events:{"click .post-btn":"submitPost","click .add-image-btn":"addImages","click .cancel-btn":"onCancel"},initialize:function(e){var t=this;e=e||{},_.bindAll(t,"onSend"),_.extend(t,_.pick(e,["recreateOnPost","hideOnBlur","skipUploaderModal","isEdit"])),t.listenTo(t.model,"comment.postError",t.renderError),t.manager=e.manager,t.hideOnBlur&&setTimeout(function(){t.setupHideOnBlur()},0)},setupHideOnBlur:function(){var t="click.{0}".format(_.uniqueId("outside")),n=$(e),i=this;n.on(t,function(e){i.$(".js-body-input").val().length||0!=$(e.target).closest([".js-comment-poster",".discuss",".modal",".modal-backdrop",".dropdown-backdrop"].join(",")).length||(n.off(t),i.destroyAndRemove(),i.trigger("canceled"))})},getTemplateContext:function(){var e=this.model,t=e.hasDesignation(),n=e.isIMadeIt();return _.extend(e.toJSON(),{commentBody:e.get("body"),submitLabel:this.submitLabel,isMobile:s.isMobile(),isIMadeIt:n,isEdit:!!this.isEdit,typeSelected:t||n})},render:function(){var e=this,t=e.getTemplateContext(),n=s.session.authenticated(),i=s.isMobile();return e.$el.html(e.template(t)),n&&e.createImageBucket(),!i&&n&&e.enableRedactorToolbar(),i&&e.$(".js-body-input").on("change keyup keydown paste cut",function(){$(this).height(0).height(this.scrollHeight)}),e},renderError:function(e){this.$(".alert-error").text(e).show()},createImageBucket:function(){var e=this,t=e.model.get("fileSet"),n=e.$(".uploading-indicator");e.imageBucket=new s.views.ImageBucketView({el:e.$(".image-bucket"),collection:t,skipUploaderModal:e.skipUploaderModal,multiple:!0}),e.listenTo(e.imageBucket,"imagebucket:uploading imagebucket:uploadcomplete",function(){n.toggle()})},enableRedactorToolbar:function(){this.redactorView=new s.views.RedactorTextAreaView({el:this.$(".js-redactor-container"),redactorOptions:{focus:!0,plugins:["instructablesAir"],linebreaks:!0}})},validate:function(){var e=this,t=!0;return e.$(".js-body-input").val()&&!e.$(".redactor_placeholder").length||(e.renderError("Please type your comment before posting."),t=!1),e.model.get("IMadeIt")&&!e.imageBucket.collection.models.length&&(e.renderError("Please attach images to show what you made!"),t=!1),t},submitPost:function(){var t=this,n=t.model;s.requireLogin(function(){var e;t.$(".alert-error").hide(),t.validate()&&((e=t.$(".post-btn")).prop("disabled",!0),n.set({body:t.$(".js-body-input").val().replace(/\n/g,"<br/>")}),n.set({fileSet:new s.collections.FileCollection(t.imageBucket.collection.models)}),t.sendRequest().done(t.onSend).always(function(){e.prop("disabled",!1)}))},{sourcea:"comments:post"})},sendRequest:function(){return this.model.save()},addImages:function(){var e=this;s.requireLogin(function(){e.imageBucket.addImages()},{sourcea:"comments:addImages"})},onSend:function(){var e,t,n=this;$(".redactor_air").hide(),n.recreateOnPost?((t=(e=n.model).cloneWithoutUserSuppliedData()).collection=e.collection,n.destroy(),new n.constructor({el:n.$el,recreateOnPost:!0,model:t}).render()):n.destroyAndRemove(),n.trigger("posted")},onCancel:function(){$(".redactor_air").hide(),this.destroyAndRemove(),this.trigger("canceled")},destroy:function(){var e=this;e.$(".js-body-input").off().val(""),e.stopListening(),e.undelegateEvents(),e.$el.removeData().unbind(),e.model=null,e.imageBucket&&(e.imageBucket.destroy(),e.imageBucket=null),e.redactorView&&e.redactorView.reset(),e.manager=null,e.trigger("destroyed")},destroyAndRemove:function(){this.destroy(),this.$el.remove()}})}((window,document),Ibles),function(e){e.package("Ibles.views"),e.views.CommentReplyPostingView=e.views.CommentPostingView.fullExtend({hideOnBlur:!1,submitLabel:"Reply"})}(Ibles),function(e){e.package("Ibles.views"),e.views.CommentEditView=e.views.CommentPostingView.fullExtend({submitLabel:"Save",sendRequest:function(){return this.model.editRequest()},getTemplateContext:function(){return _.extend(this._super(),{isEdit:!0,typeSelected:!0})}})}(Ibles),function(n,s,o){o.package("Ibles.views"),o.views.CommentsManager=Backbone.View.extend({listSelector:".js-comments",itemSelector:".js-comment",moreSelector:".js-more-comments",model:null,numCommentsToLoad:50,numVisibleReplies:0,fetchIMadeItsOnly:!1,saveIMadeItsOnly:!1,skipUploaderModal:!1,fetchRatings:!1,events:{"click .js-more-comments":"addComments","click .js-show-poster":"renderPoster"},initialize:function(e){var t=this,n=o.session.authenticated();_.bindAll(t,"renderComment","renderAllComments","onCommentAdded","showCommentFromUrl"),_.extend(t,_.pick(e,["fetchIMadeItsOnly","saveIMadeItsOnly","skipUploaderModal","fetchRatings","numVisibleReplies","numCommentsToLoad","additionalCommentContext"])),t.setSubviewClasses(),t.setCommentModelClasses(),t.setCommentCollection(),n||t.createCommentViewsFromDOM();var i=t.collection;t.listenTo(i,"add",t.onCommentAdded),t.listenTo(i,"reset",t.onCommentsLoaded),t.listenToOnce(i,"noMoreComments",t.noMoreComments),this.shouldReloadCommentTree()?this.reloadCommentTree(t.showCommentFromUrl):t.showCommentFromUrl()},shouldReloadCommentTree:function(){return o.session.authenticated()},reloadCommentTree:function(e){this.collection&&this.collection.reloadCommentTree().done(e)},setSubviewClasses:function(){this.postingView=o.views.CommentPostingView,this.commentView=o.views.CommentView,this.editView=o.views.CommentEditView,this.replyPostingView=o.views.CommentReplyPostingView},createCommentViewsFromDOM:function(){var n=[],i=this;i.$(i.listSelector).children(i.itemSelector).each(function(){var e=$(this),t=i.makeCommentView({el:e,htmlPreRendered:!0});t.render(),n.push(t)}),i.commentItemViews=n},setCommentModelClasses:function(){this.commentModelClass=o.models.CommentModel,this.commentCollectionClass=o.collections.CommentCollection},setCommentCollection:function(){var e=this;e.collection||(e.collection=new this.commentCollectionClass([],_.extend({limit:e.numCommentsToLoad,numVisibleReplies:e.numVisibleReplies,IMadeIt:e.fetchIMadeItsOnly,fetchRatings:e.fetchRatings},e.getExtraCollectionProps())))},getExtraCollectionProps:function(){return{instructableId:this.model.get("id"),ratingOptions:["instructableId"],modelOptions:["instructableId"]}},makeCommentModel:function(e){return new this.commentModelClass(_.extend({},{instructableId:this.model.get("id"),IMadeIt:this.saveIMadeItsOnly},e),{collection:this.collection})},makeCommentView:function(e){return new this.commentView(_.extend({},{collection:this.collection,manager:this},e))},makeReplyPostingModel:function(e){return this.makeCommentModel({inReplyTo:e.get("id"),replyAuthor:e.get("author"),designations:e.isQuestion()?["answer"]:["comment"]})},makeReplyPostingView:function(e){return new this.replyPostingView({skipUploaderModal:this.skipUploaderModal,model:this.makeReplyPostingModel(e)})},makeEditView:function(e){return new(this.editView||this.postingView)({model:e,manager:this,collection:this.collection,skipUploaderModal:this.skipUploaderModal,isEdit:!0})},addComments:function(){this.collection.fetch()},noMoreComments:function(){this.$(this.moreSelector).hide()},onCommentAdded:function(e,t){this.renderComment(e,t)},onCommentsLoaded:function(){this.renderAllComments()},renderComment:function(e){var t=this,n=t.makeCommentView({model:e}).render().$el,i=t.$(t.itemSelector),s=e.collection.indexOf(e),o=t.listSelector;0===s?t.$(o).prepend(n):s===i.length?t.$(o).append(n):i.eq(s).before(n),t.$el.removeClass("hide")},renderAllComments:function(){var e=this.$(this.listSelector);_.each(this.commentItemViews,function(e){e.destroy()}),e.css({"min-height":e.outerHeight()}),e.empty(),this.collection.each(this.renderComment),e.css({"min-height":"initial"})},renderPoster:function(i){var s=this;i.preventDefault(),o.requireLogin(function(){var e=new s.postingView({model:s.makeCommentModel({designations:["comment"]}),skipUploaderModal:s.skipUploaderModal,manager:s}),t=e.render().$el.hide(),n=$(i.target);s.$el.append(t),t.show("slow"),n.attr("disabled",!0),s.listenToOnce(e,"posted destroyed",function(){n.attr("disabled",!1)}),s.listenToOnce(e,"posted",function(){var e=s.$el;e.removeClass("hide"),$("body,html").animate({scrollTop:e.offset().top},"slow")})},{sourcea:"comments:showPoster"})},getCommentIdFromUrl:function(){return n.location.hash.slice(1).replace("comment-","")||o.Q("commentId")},hasCommentId:function(e){return!!this.collection.get(e)},showAllComments:function(){this.$(".js-show-replies").click()},showCommentFromUrl:function(){var e=this,t=e.getCommentIdFromUrl();t&&e.hasCommentId(t)&&(e.showAllComments(),n.setTimeout(function(){e.scrollToComment(t)},100))},scrollToComment:function(e){var t,n,i=e&&$('[data-id="'+e+'"]');i&&(t=i.offset().top-$("#ible-header").outerHeight()-50,n="true"===o.Q("reply"),$(s).scrollTop(t),n&&i.find(".js-reply").click())},showRepliesStartingFromModel:function(e){for(var t,n=this.collection,i=n.indexOf(e)+1,s=n.length-1,o=n.models;i<=s&&(t=o[i]).isReply();i++)t.set("visible","true")}})}(window,document,Ibles),function(e){e.package("Ibles.views"),e.views.CommentDeletePrompt=e.views.BaseModalView.fullExtend({events:{"click .delete-btn":"deleteComment"},initialize:function(e){this._super(_.extend({wrapContent:!0,modalClass:"delete-prompt"},e))},getTemplate:function(){return _.template(e.JST["comment-delete-prompt"])},deleteComment:function(e){e.preventDefault(),$(e.currentTarget).html($("<span class='spinner'></span>")[0]).addClass("disabled"),this.showDeleteAction(this.options.deleteThread?this.model.deleteThread():this.model.deleteComment())},showDeleteAction:function(e){var t=this;e.then(function(){t.dismiss()}).fail(function(){t.$(".cancel-btn").remove(),t.$(".delete-btn").remove(),t.$(".alert-error").removeClass("hide")})}})}(Ibles),Ibles.package("Ibles.views"),Ibles.views.CommentRepliesManager=Ibles.views.CommentsManager.fullExtend({model:null,collection:null,initialize:function(e){this._super(e),this.comment=e.comment},shouldReloadCommentTree:function(){return!0},onCommentsLoaded:function(){this.hydratePrimaryCommentModel(),this.renderAllComments()},makeCommentView:function(e){return this._super(_.extend({lazyImage:!1},e))},hydratePrimaryCommentModel:function(){var e=this.comment,t=e.get("id"),n=this.collection.get(t);n&&e.set(n.attributes,{silent:!0})},renderAllComments:function(){var t=this,n=t.collection;n.each(function(e){t.renderComment(e,n)})}}),Ibles.package("Ibles.views"),Ibles.views.CommentModal=Ibles.views.BaseModalView.fullExtend({template:_.template(Ibles.JST["comment-modal"]),model:null,modalEventNamespace:"CommentModal",browserScrollable:!0,events:{"click .js-next":"nextComment","click .js-prev":"previousComment"},initialize:function(e){this._super(e),this.repliesCollection=this.createRepliesCollection(),this.repliesView=this.createRepliesView(),this.listenTo(this.repliesCollection,"reset",this.renderComponents)},createRepliesCollection:function(){return new Ibles.collections.CommentCollection([],{commentId:this.model.get("id"),instructableId:this.options.instructableModel.get("id")})},createRepliesView:function(){return new Ibles.views.CommentRepliesManager({el:this.$(".js-replies"),model:this.options.instructableModel,comment:this.model,collection:this.repliesCollection,skipUploaderModal:!0})},nextComment:function(){var e=this.model,t=e.collection,n=t.indexOf(e),i=n===t.length-1?0:n+1;Ibles.Events.trigger("{0}:next".format(this.modalEventNamespace),i)},previousComment:function(){var e=this.model,t=e.collection,n=t.indexOf(e),i=0===n?t.length-1:n-1;Ibles.Events.trigger("{0}:prev".format(this.modalEventNamespace),i)},getTemplateContext:function(){var e=this.model;return _.extend(this._super(),e.toJSON(),{hideNavigation:1===e.collection.length})},modalHidden:function(){this.model=null,this.repliesCollection=null,this.repliesView=null},renderComponents:function(){this.renderPrimaryComment(),this.model.get("fileSet").hasImages()&&this.renderCommentGallery()},renderPrimaryComment:function(){this.repliesView.makeCommentView({model:this.model,el:this.$(".js-primary-comment"),showPhotos:!1,lazyImage:!1}).render()},renderCommentGallery:function(){var e=_.template(Ibles.JST["comment-modal-gallery"]),t=Ibles.isMobile()?175:450,n=this.$(".modal-body").width(),i=this.model.get("fileSet").getImages(),s=this.galleryWillScroll(i,n,t);this.$(".js-gallery").append(e({galleryHeight:s?t:void 0,imageFiles:i,willScroll:s})),new Ibles.views.ScrollableCardsView({el:this.$(".js-gallery").children().first()})},galleryWillScroll:function(e,t,n){var i,s=e&&1<e.length,o=n;return s&&(i=_.reduce(e,function(e,t){return e+o*(t.get("width")/t.get("height"))},0)),s&&t<i}}),Ibles.JST["comment-image-file"]='<a rel="fancybox-thumb-<< commentId >>" href="<< imageLink >>" data-fancybox-href="/file/ << id >>">\n    <[ if (lazyImage) {]>\n        <img class="photo fancybox-thumb lazyload" alt="<< name >>" data-image-id="<< id >>" data-notes=\'<< imageNotes >>\' data-orig-height="<< height >>" data-orig-width="<< width >>" src="<< Ibles.staticUrl(\'img/pixel.png\') >>" data-src="<< imageSrc >>"/>\n    <[ } else { ]>\n        <img class="photo fancybox-thumb" alt="<< name >>" data-image-id="<< id >>" data-notes=\'<< imageNotes >>\' data-orig-height="<< height >>" data-orig-width="<< width >>" src="<< imageSrc >>"/>\n    <[ } ]>\n</a>\n',Ibles.JST["comment-flag-dropdown"]='<div class="action dropdown flag-dropdown hide">\n    <a class="dropdown-toggle" data-toggle="dropdown" href="#"><i class="icon-flag"></i></a>\n    <ul class="dropdown-menu">\n        <li><a class="js-flag" data-flagname="not_nice">Not Nice</a></li>\n        <li><a class="js-flag" data-flagname="inappropriate">Inappropriate</a></li>\n        <li><a class="js-flag" data-flagname="spam">Spam</a></li>\n    </ul>\n</div>\n',Ibles.JST["comment-admin"]='<div class="comment-admin">\n    <span class="checkbox pull-right action">\n        <input type="checkbox" class="js-approved" name=""/>Approved\n    </span>\n    <[ if (hasChildren){]>\n        <a class="action pull-right js-del-thread">[delete thread]</a>\n    <[ } else { ]>\n        <a class="action pull-right js-del-comment">[delete]</a>\n    <[ } ]>\n    <a class="action pull-right js-publish <[ if (!limbo && !quarantine) {]>hide<[}]>">[publish]</a>\n    <a class="action pull-right js-limbo <[ if (limbo) {]>hide<[}]>">[limbo]</a>\n    <a class="action pull-right js-quarantine  <[ if (quarantine) {]>hide<[}]>">[quarantine]</a>\n    <[ if (Ibles.pageContext.ibleData && Ibles.pageContext.ibleData.lessonId) { ]>\n        <a class="action pull-right js-limbo-class-projects">[limbo projects]</a>\n    <[ } ]>\n    <[ if (!inReplyTo) {]>\n    <a class="action pull-right js-to-tip <[ if (designatedTip) {]>hide<[}]>">[tip]</a>\n    <a class="action pull-right js-to-question <[ if (designatedQuestion) {]>hide<[}]>">[question]</a>\n    <a class="action pull-right js-to-comment <[ if (designatedComment) {]>hide<[}]>">[comment]</a>\n    <[ } ]>\n\n    <span class="checkbox pull-right action">\n        <input type="checkbox" class="js-imadeit" <[ if (IMadeIt) {]>checked<[}]>> IMadeIt <span class="alert-error imadeit-warning hide">(images required)</span>\n    </span>\n\n    <span class="checkbox pull-right action">\n        <input type="checkbox" class="js-sticky" name=""/>Feature Comment\n    </span>\n\n    <img class="request-img pull-right hide" src="<< Ibles.staticUrl(\'img/spinner.gif\') >>" height=\'10\' width=\'10\'/>\n    <img class="request-success pull-right hide" src="<< Ibles.staticUrl(\'img/ico_check.gif\') >>" height=\'10\' width=\'10\'/>\n    <img class="request-failure pull-right hide" src="<< Ibles.staticUrl(\'img/ico_cross.gif\') >>" height=\'10\' width=\'10\'/>\n</div>\n',function(u){u.package("Ibles.views"),u.views.CommentView=u.views.BaseCommentView.fullExtend({quarantineMessage:"THIS COMMENT HAS BEEN QUARANTINED",limboMessage:"THIS COMMENT HAS BEEN LIMBOED",imageTemplate:_.template(u.JST["comment-image-file"]),flagTemplate:_.template(u.JST["comment-flag-dropdown"]),adminActionsTemplate:_.template(u.JST["comment-admin"]),events:{"click .js-flag":"flagComment","click .js-to-tip":"makeTip","click .js-to-question":"makeQuestion","click .js-to-comment":"makeComment","click .js-imadeit":"toggleIMadeIt","click .js-edit":"editComment","click .js-limbo":"limboComment","click .js-quarantine":"quarantine","click .js-publish":"publishComment","click .js-sticky":"toggleSticky","click .js-approved":"toggleApproval","click .js-limbo-class-projects":"limboClassProjects"},initialize:function(e){this._super(e)},designate:function(e){this.showRequestFeedback(this.model.setDesignations(e)),this.model.get("IMadeIt")&&this.model.setIMadeIt(!1)},makeTip:function(){this.designate(["tip"])},makeQuestion:function(){this.designate(["question"])},makeComment:function(){this.designate(["comment"])},render:function(){var e,t,n,i=this,s=i.manager,o=i.model,a=u.session,r=a.isAdmin(),l=a.authenticated(),c=o.currentUserIsAuthor(),d=o.authorIsProjectOwner(s.model);return i._super(),r&&(i.$el.append(i.adminActionsTemplate(i.getTemplateContext())),e=o.get("status"),t=o.get("quarantine")||"QUARANTINED"==e,n=o.get("limbo")||"LIMBO"==e,(t||n)&&(i.$(".js-quarantine-message").html(t?i.quarantineMessage:i.limboMessage).show(),i.$(".js-publish").show()),t?i.$(".js-limbo").show():n?i.$(".js-quarantine").show():i.$(".js-limbo, .js-quarantine").show()),l&&i.$(".js-toolbar").prepend(i.flagTemplate()),d&&i.$(".author").addClass("owner"),o.get("author")===a.get("screenName")&&i.$(".js-del-comment").show(),!0===o.get("sticky")&&i.$(".js-sticky").prop("checked",!0),!0===o.get("approved")&&i.$(".js-approved").prop("checked",!0),(c||r)&&i.$(".js-toolbar").prepend(i.authorOptsTemplate(i.getTemplateContext())),i.attachCommentImagesFancybox(),i},flagComment:function(e){this.showRequestFeedback(this.model.flagComment($(e.currentTarget).data("flagname")))},limboComment:function(){this.showRequestFeedback(this.model.limbo()),this.$(".js-limbo").hide(),this.$(".js-publish, .js-quarantine").show(),this.$(".js-quarantine-message").html(this.limboMessage).show()},quarantine:function(){this.showRequestFeedback(this.model.quarantine()),this.$(".js-quarantine").hide(),this.$(".js-publish, .js-limbo").show(),this.$(".js-quarantine-message").html(this.quarantineMessage).show()},publishComment:function(){this.showRequestFeedback(this.model.publish()),this.$(".js-limbo").show(),this.$(".js-publish").hide(),this.$(".js-quarantine-message").hide()},toggleSticky:function(e){this.showRequestFeedback(this.model.toggleStickyComment($(e.currentTarget).prop("checked")))},toggleApproval:function(e){this.showRequestFeedback(this.model.toggleApproval($(e.currentTarget).prop("checked")))},showRequestFeedback:function(e){var t=this;this.$(".request-img").show(),e.then(function(){t.$(".request-img").hide(),t.$(".request-success").show(),t.$(".request-success").fadeOut()}).fail(function(){t.$(".request-img").hide(),t.$(".request-failure").show(),t.$(".request-failure").fadeOut()})},attachCommentImagesFancybox:function(){this.$(this.photosSelector).find("a").fancybox()},editComment:function(){var e=this,t=e.$(".js-edit-container"),n=e.manager.makeEditView(e.model);e.toggleSpaceForEditView(),e.editView=n,t.html(n.render().$el),e.listenTo(n,"canceled",e.onEditViewCanceled),e.listenTo(n,"posted",e.onEditViewPosted)},toggleSpaceForEditView:function(){this.$(".js-edit").toggle(),this.$(".js-hide-on-edit").toggle(),this.$(".js-text").toggle(),this.$(".js-photos").toggle()},onEditViewCanceled:function(){this.editView&&(this.toggleSpaceForEditView(),this.editView.destroy(),this.editView=null)},onEditViewPosted:function(){var e=this,t=e.model,n=e.manager.makeCommentView({model:t,lazyImage:!1}).render();e.editView.destroy(),e.editView=null,e.destroy(),e.$el.replaceWith(n.$el)},limboClassProjects:function(){var i,s,e=this.manager.model.containingCourse;confirm("Do you want to limbo all projects by "+this.model.get("author")+" in this class ("+e.get("title"),NaN)&&(i=this.model.get("authorId"),s=[],_.each(e.get("instructables"),function(e){u.API.getRequest("getComments",{instructableId:e.id,limit:200}).then(function(e){_.each(e.comments,function(e){var t,n;e.authorId!==i||e.limbo||(t={status:"LIMBO",id:e.id},n=u.API.jsonPostRequest("adminComment",t),s.push(n))})})}),this.showRequestFeedback($.when.apply(this,s)))},toggleIMadeIt:function(){var e=this.model,t=this.$(".imadeit-warning");t.hide();var n=e.setIMadeIt(this.$(".js-imadeit").is(":checked"));n.fail(function(){t.show()}),this.showRequestFeedback(n)}}),u.views.DesktopCommentView=u.views.CommentView}(Ibles),Ibles.JST["imadeit-item"]='<li data-id="<< id >>" class="imadeit js-comment <[ if (typeof hidden != \'undefined\' && hidden) {]>hide<[}]>">\n    <[ if (fileSet.models[0].isImage()) { ]>\n        <img class="lazyload" src="<< Ibles.staticUrl(\'img/pixel.png\') >>" data-src="<< fileSet.models[0].getSquare3AnimationUrl() >>">\n    <[ } else if (fileSet.models[0].isVideo()) { ]>\n        <img src="<< Ibles.staticUrl(\'img/placeholder-video.png\') >>" />\n    <[ } else { ]>\n        <img src="<< Ibles.staticUrl(\'img/placeholder-file.png\') >>" />\n    <[ } ]>\n    <h3 class="made-by"><a class="user" href="<< Ibles.reverseUrls.memberUrl(author) >>"><< author >></a> made it!</h3>\n</li>\n',Ibles.JST["imadeit-seemore"]='<li class="see-more">\n    <div class="see-more-inner">\n        <p>See << hiddenCount >> more that made it</p>\n    </div>\n</li>',Ibles.package("Ibles.views"),Ibles.views.ImadeItsManager=Ibles.views.CommentsManager.fullExtend({fetchIMadeItsOnly:!0,saveIMadeItsOnly:!0,events:{"click .see-more":"showHiddenItems"},initialize:function(e){this._super(e),this.listenTo(Ibles.Events,"iMadeItModal:next iMadeItModal:prev",this.onImadeItModalNav)},setSubviewClasses:function(){this._super(),this.commentView=Ibles.views.ImadeItItemView},setCommentModelClasses:function(){this.commentModelClass=Ibles.models.CommentModel,this.commentCollectionClass=Ibles.collections.ImadeItCollection},onCommentsLoaded:function(){this.setHiddenModels(),this.renderAllComments(),this.renderSeeMoreToggler()},onImadeItModalNav:function(e){new Ibles.views.ImadeItModal({model:this.collection.at(e),instructableModel:this.model}).render()},renderSeeMoreToggler:function(){var e,t=this.getHiddenCount();0<t&&(e=_.template(Ibles.JST["imadeit-seemore"]),this.$(this.listSelector).append(e({hiddenCount:t})))},showHiddenItems:function(){var e=this;Ibles.requireLogin(function(){e.$(".see-more").hide(),e.$("li.hide").removeClass("hide")},{sourcea:"imadeitSeeMore"})},showAllComments:function(){this.showHiddenItems()},getHiddenCount:function(){var e=this.collection.length,t=0;return 9<e?t=e-9:4<e&&9!=e&&(t=e-4),t},setHiddenModels:function(){var e=this.collection,n=e.length-this.getHiddenCount();e.each(function(e,t){e.set("hidden",n<=t)})}}),Ibles.package("Ibles.views"),Ibles.views.ImadeItItemView=Ibles.views.CommentView.fullExtend({template:_.template(Ibles.JST["imadeit-item"]),events:{click:"renderModal"},makeCommentModelFromEl:function(){var e=this.$el,t=(e.find("img").attr("src")||"").split("?")[0];return this.manager.makeCommentModel({id:e.data().id,author:e.find(".user").text(),files:[{originalUrl:t}]})},renderModal:function(){new Ibles.views.ImadeItModal({model:this.model,instructableModel:this.manager.model}).render()},onEditViewPosted:function(){this.manager.reloadCommentTree()}}),Ibles.package("Ibles.collections"),Ibles.collections.ImadeItCollection=Ibles.collections.CommentCollection.extend({apiEndPoint:"searchComments",getExtraCollectionProps:function(){return _.extend(this.super(),{IMadeIt:!0})}}),Ibles.package("Ibles.views"),Ibles.views.ImadeItModal=Ibles.views.CommentModal.fullExtend({modalClass:"imadeit-modal",modalEventNamespace:"iMadeItModal"}),Ibles.JST["hamburger-menu-auth-section"]='<div id="auth-section" class="clearfix">\n    <li class="auth-section-links">\n        <a class="main-menu profile-link" data-bypass="true" href="<< memberUrl >>">\n            <img class="avatar" src="<< avatarUrl >>"/> Profile\n        </a>\n        <a class="main-menu logout-link btn-logout">\n            Logout\n        </a>\n    </li>\n</div>\n',window.Modernizr=function(i,u,a){function t(e){f.cssText=e}function o(e,t){return typeof e===t}function s(e,t){return!!~(""+e).indexOf(t)}function r(e,t){for(var n in e){var i=e[n];if(!s(i,"-")&&f[i]!==a)return"pfx"!=t||i}return!1}function l(e,t,n){var i=e.charAt(0).toUpperCase()+e.slice(1),s=(e+" "+y.join(i+" ")+i).split(" ");return o(t,"string")||void 0===t?r(s,t):function(e,t,n){for(var i in e){var s=t[e[i]];if(s!==a)return!1===n?e[i]:o(s,"function")?s.bind(n||t):s}return!1}(s=(e+" "+I.join(i+" ")+i).split(" "),t,n)}function e(e,t,n,i){var s,o,a,r,l=u.createElement("div"),c=u.body,d=c||u.createElement("body");if(parseInt(n,10))for(;n--;)(a=u.createElement("div")).id=i?i[n]:p+(n+1),l.appendChild(a);return s=["&#173;",'<style id="s',p,'">',e,"</style>"].join(""),l.id=p,(c?l:d).innerHTML+=s,d.appendChild(l),c||(d.style.background="",d.style.overflow="hidden",r=m.style.overflow,m.style.overflow="hidden",m.appendChild(d)),o=t(l,e),c?l.parentNode.removeChild(l):(d.parentNode.removeChild(d),m.style.overflow=r),!!o}var n,c,d,h={},m=u.documentElement,p="modernizr",f=u.createElement(p).style,g=u.createElement("input"),b=":)",v=" -webkit- -moz- -o- -ms- ".split(" "),w="Webkit Moz O ms",y=w.split(" "),I=w.toLowerCase().split(" "),C={},x={},k={},S=[],T=S.slice,A=(c={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"},function(e,t){t=t||u.createElement(c[e]||"div");var n=(e="on"+e)in t;return n||(t.setAttribute||(t=u.createElement("div")),t.setAttribute&&t.removeAttribute&&(t.setAttribute(e,""),n=o(t[e],"function"),void 0===t[e]||(t[e]=a),t.removeAttribute(e))),t=null,n}),M={}.hasOwnProperty,j=void 0!==M&&void 0!==M.call?function(e,t){return M.call(e,t)}:function(e,t){return t in e&&void 0===e.constructor.prototype[t]};for(d in Function.prototype.bind||(Function.prototype.bind=function(i){var s=this;if("function"!=typeof s)throw new TypeError;var o=T.call(arguments,1),a=function(){if(this instanceof a){function e(){}e.prototype=s.prototype;var t=new e,n=s.apply(t,o.concat(T.call(arguments)));return Object(n)===n?n:t}return s.apply(i,o.concat(T.call(arguments)))};return a}),C.flexbox=function(){return l("flexWrap")},C.flexboxlegacy=function(){return l("boxDirection")},C.touch=function(){var t;return"ontouchstart"in i||i.DocumentTouch&&u instanceof DocumentTouch?t=!0:e(["@media (",v.join("touch-enabled),("),p,")","{#modernizr{top:9px;position:absolute}}"].join(""),function(e){t=9===e.offsetTop}),t},C.rgba=function(){return t("background-color:rgba(150,255,150,.5)"),s(f.backgroundColor,"rgba")},C.multiplebgs=function(){return t("background:url(https://),url(https://),red url(https://)"),/(url\s*\(.*?){3}/.test(f.background)},C.boxshadow=function(){return l("boxShadow")},C.textshadow=function(){return""===u.createElement("div").style.textShadow},C.opacity=function(){return t(v.join("opacity:.55;")+""),/^0.55$/.test(f.opacity)},C.cssanimations=function(){return l("animationName")},C.cssgradients=function(){var e="background-image:";return t((e+"-webkit- ".split(" ").join("gradient(linear,left top,right bottom,from(#9f9),to(white));"+e)+v.join("linear-gradient(left top,#9f9, white);"+e)).slice(0,-e.length)),s(f.backgroundImage,"gradient")},C.csstransforms=function(){return!!l("transform")},C.csstransforms3d=function(){var n=!!l("perspective");return n&&"webkitPerspective"in m.style&&e("@media (transform-3d),(-webkit-transform-3d){#modernizr{left:9px;position:absolute;height:3px;}}",function(e,t){n=9===e.offsetLeft&&3===e.offsetHeight}),n},C.csstransitions=function(){return l("transition")},C.generatedcontent=function(){var t;return e(["#",p,"{font:0/0 a}#",p,':after{content:"',b,'";visibility:hidden;font:3px/1 a}'].join(""),function(e){t=3<=e.offsetHeight}),t},C)j(C,d)&&(n=d.toLowerCase(),h[n]=C[d](),S.push((h[n]?"":"no-")+n));return h.input||(h.input=function(e){for(var t=0,n=e.length;t<n;t++)k[e[t]]=e[t]in g;return k.list&&(k.list=!!u.createElement("datalist")&&!!i.HTMLDataListElement),k}("autocomplete autofocus list placeholder max min multiple pattern required step".split(" ")),h.inputtypes=function(e){for(var t,n,i,s=0,o=e.length;s<o;s++)g.setAttribute("type",n=e[s]),(t="text"!==g.type)&&(g.value=b,g.style.cssText="position:absolute;visibility:hidden;",/^range$/.test(n)&&g.style.WebkitAppearance!==a?(m.appendChild(g),t=(i=u.defaultView).getComputedStyle&&"textfield"!==i.getComputedStyle(g,null).WebkitAppearance&&0!==g.offsetHeight,m.removeChild(g)):/^(search|tel)$/.test(n)||(t=/^(url|email)$/.test(n)?g.checkValidity&&!1===g.checkValidity():g.value!=b)),x[e[s]]=!!t;return x}("search tel url email datetime date month week time datetime-local number range color".split(" "))),h.addTest=function(e,t){if("object"==typeof e)for(var n in e)j(e,n)&&h.addTest(n,e[n]);else{if(e=e.toLowerCase(),h[e]!==a)return h;t="function"==typeof t?t():t,m.className+=" "+(t?"":"no-")+e,h[e]=t}return h},t(""),g=null,h._version="2.7.0",h._prefixes=v,h._domPrefixes=I,h._cssomPrefixes=y,h.hasEvent=A,h.testProp=function(e){return r([e])},h.testAllProps=l,h.testStyles=e,h.prefixed=function(e,t,n){return t?l(e,t,n):l(e,"pfx")},m.className=m.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(" js "+S.join(" ")),h}(this,this.document),function(r,t){"use strict";var n=t.Modernizr,i=r("body");r.DLMenu=function(e,t){this.$el=r(t),this._init(e)},r.DLMenu.defaults={animationClasses:{classin:"dl-animate-in-1",classout:"dl-animate-out-1"},onLevelClick:function(e,t){return!1},onLinkClick:function(e,t){return!1}},r.DLMenu.prototype={_init:function(e){this.options=r.extend(!0,{},r.DLMenu.defaults,e),this._config(),n&&(this.animEndEventName={WebkitAnimation:"webkitAnimationEnd",OAnimation:"oAnimationEnd",msAnimation:"MSAnimationEnd",animation:"animationend"}[n.prefixed("animation")]+".dlmenu",this.transEndEventName={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd",transition:"transitionend"}[n.prefixed("transition")]+".dlmenu",this.supportAnimations=n.cssanimations,this.supportTransitions=n.csstransitions),this._initEvents()},_config:function(){this.open=!1,this.$trigger=this.$el.children(".dl-trigger"),this.$menu=this.$el.children("ul.dl-menu"),this.$menuitems=this.$menu.find("li:not(.dl-back)"),this.$el.find("ul.dl-submenu").prepend('<li class="dl-back"><a href="#">back</a></li>'),this.$back=this.$menu.find("li.dl-back")},_initEvents:function(){var a=this;this.$trigger.on("click.dlmenu",function(){return a.open?a._closeMenu():a._openMenu(),!1}),this.$menuitems.on("click.dlmenu",function(e){var t=r(this),n=t.children("ul.dl-submenu");if(t.hasClass("passthrough")||e.stopPropagation(),0<n.length){var i=n.clone().css("opacity",0).insertAfter(a.$menu),s=function(){a.$menu.off(a.animEndEventName).removeClass(a.options.animationClasses.classout).addClass("dl-subview"),t.addClass("dl-subviewopen").parents(".dl-subviewopen:first").removeClass("dl-subviewopen").addClass("dl-subview"),i.remove()};return setTimeout(function(){i.addClass(a.options.animationClasses.classin),a.$menu.addClass(a.options.animationClasses.classout),a.supportAnimations?a.$menu.on(a.animEndEventName,s):s.call(),a.options.onLevelClick(t,t.children("a:first").text())}),!1}a.options.onLinkClick(t,e)}),this.$back.on("click.dlmenu",function(e){function t(){a.$menu.off(a.animEndEventName).removeClass(a.options.animationClasses.classin),o.remove()}var n=r(this),i=n.parents("ul.dl-submenu:first"),s=i.parent(),o=i.clone().insertAfter(a.$menu);return setTimeout(function(){o.addClass(a.options.animationClasses.classout),a.$menu.addClass(a.options.animationClasses.classin),a.supportAnimations?a.$menu.on(a.animEndEventName,t):t.call(),s.removeClass("dl-subviewopen");var e=n.parents(".dl-subview:first");e.is("li")&&e.addClass("dl-subviewopen"),e.removeClass("dl-subview")}),!1})},closeMenu:function(){this.open&&this._closeMenu()},_closeMenu:function(){function e(){t.$menu.off(t.transEndEventName),t._resetMenu()}var t=this;this.$menu.removeClass("dl-menuopen"),this.$menu.addClass("dl-menu-toggle"),this.$trigger.removeClass("dl-active"),r(".overlay").removeClass("visible"),r("body").removeClass("stop-scrolling"),r("html").removeClass("stop-scrolling"),this.supportTransitions?this.$menu.on(this.transEndEventName,e):e.call(),this.open=!1},openMenu:function(){this.open||this._openMenu()},_openMenu:function(){var e=this;this.$menu.trigger("dlmenu.startOpen"),i.off("click").on("click.dlmenu",function(){e._closeMenu()}),this.$menu.addClass("dl-menuopen dl-menu-toggle").on(this.transEndEventName,function(){r(this).removeClass("dl-menu-toggle")}),this.$trigger.addClass("dl-active"),r("html").addClass("stop-scrolling"),r("body").addClass("stop-scrolling"),r(".overlay").addClass("visible"),this.open=!0},_resetMenu:function(){this.$menu.removeClass("dl-subview"),this.$menuitems.removeClass("dl-subview dl-subviewopen")}};function s(e){t.console&&t.console.error(e)}r.fn.dlmenu=function(t){var n;return"string"==typeof t?(n=Array.prototype.slice.call(arguments,1),this.each(function(){var e=r.data(this,"dlmenu");e?r.isFunction(e[t])&&"_"!==t.charAt(0)?e[t].apply(e,n):s("no such method '"+t+"' for dlmenu instance"):s("cannot call methods on dlmenu prior to initialization; attempted to call method '"+t+"'")})):this.each(function(){var e=r.data(this,"dlmenu");e?e._init():e=r.data(this,"dlmenu",new r.DLMenu(t,this))}),this}}(jQuery,window),function(n,o){o.package("Ibles.views"),o.views.HamburgerMenu=Backbone.View.extend({initialize:function(e){var t=this;e&&e.async?this.getMenuContents().done(function(){t.bindMenuPlugin(),t.enableResize(),t.updateAuthUI()}):(t.bindMenuPlugin(),t.enableResize(),t.updateAuthUI())},bindMenuPlugin:function(){this.$el.dlmenu({})},enableResize:function(){var e=this;e.setSizes(),$(n).resize(_.debounce(function(){e.setSizes()},250))},getMenuContents:function(){var t=this;return $.ajax("/parts/hamburger_menu/").then(function(e){t.$(".dl-menu").html(e),t.updateAuthUI()})},setSizes:function(){var e,t;o.isMobile()&&(e=$(n).height(),t=$("#main-header"),$(".overlay").height(e+70),$(".channels-menu").height(e-t.outerHeight()),$(".dl-menu").height(e-t.outerHeight()))},updateAuthUI:function(){var e,t,n,i=$(".logged-in-item"),s=$(".logged-out-item");o.session.authenticated()?(e=o.session,t=_.extend(o.session.toJSON(),{memberUrl:e.getMemberUrl(),avatarUrl:e.getAvatarUrl()}),n=_.template(o.JST["hamburger-menu-auth-section"]),$("#auth-container").html(n(t)),s.removeClass("visible"),i.addClass("visible"),$("#auth-container .btn-logout").on("click",function(){o.logout()})):(i.removeClass("visible"),s.addClass("visible"))}})}(window,Ibles),Ibles.JST["sticky-header-desktop"]='<div class="sticky-header" data-location="stickyNav">\n\t<div id="hamburger-menu" class="dl-menuwrapper hamburger-menu">\n\t\t<button class="dl-trigger"><i class="svg-icon svg-hamburger"></i><span class="sr-only">Open Menu</span></button>\n\t\t<ul class="dl-menu"></ul>\n\t</div>\n    <span class="byline">\n        <span class="title"><< title >></span> by <a class="author" rel="author" href="<< authorUrl >>"><< screenName >></a><button class="btn btn-yellow follow-btn">Follow</button>\n    </span>\n    <span class="ible-actions">\n        <[ if (type == "Step by Step") {]>\n        <button class="pdf-btn login-required" data-sourcea="download"><i class="svg-icon svg-pdf"></i>Download</button>\n        <[ } ]>\n        <button class="favorite-btn"><i class="svg-icon svg-favorite"></i><span class="favorite-txt">Favorite</span></button>\n        <[ if (type == "Step by Step") {]>\n        <button class="imadeit-btn"><i class="icon icon-imadeit"></i><span class="imadeit-txt">I Made It</span></button>\n        <button class="view-comments-btn"><a href="#discuss"><i class="svg-icon svg-comments"></i><span class="sr-only">View Comments</span></a></button>\n        <[ } ]>\n        <button class="share-menu-btn"><i class="svg-icon svg-share"></i><span class="sr-only">Share</span></button>\n        <button class="more-menu-btn"><i class="svg-icon svg-ellipsis"></i><span class="sr-only">More Options</span></button>\n    </span>\n    <div class="dropdown share-menu">\n        <button class="btn btn-facebook fb-btn"><i class="svg-icon svg-facebook"></i> Facebook</button>\n        <button class="btn btn-twitter twit-btn"><i class="svg-icon svg-twitter"></i> Twitter</button>\n        <button class="btn btn-danger pin-btn"><i class="svg-icon svg-pinterest"></i> Pinterest</button>\n        <button class="btn google-classroom-btn"><i class="icon-google-classroom"></i> Google Classroom</button>\n    </div>\n    <div class="dropdown more-menu">\n        <button class="btn flag-menu-btn">Flag</button>\n        <ul class="flag-menu unstyled hide">\n            <li><a class="flag-btn" data-as="wrong-category">Wrong Category</a></li>\n            <li><a class="flag-btn" data-as="inappropriate">Inappropriate</a></li>\n            <li><a class="flag-btn" data-as="incomplete">Incomplete</a></li>\n            <li><a class="flag-btn" data-as="spam">Spam</a></li>\n        </ul>\n        <button class="btn add-to-collection-btn">Add To Collection</button>\n        <button class="btn add-to-contest-btn admin-action">Add To Contest</button>\n        <button class="btn edit-btn author-action">Edit</button>\n    </div>\n</div>\n',Ibles.views.StickyHeaderBase=Backbone.View.extend({template:null,initialize:function(){this.render(),this.setupScrollFix()},hide:function(){},render:function(){var e=this.model,t=e.author;this.$el.append(this.template({title:e.get("title"),screenName:t.get("screenName"),authorUrl:t.getUrl(),authorAvatar:t.getAvatarFile().getTinyUrl(),type:e.get("type")}))},setupScrollFix:function(){var e=this,t=e.$(".sticky-header"),n=e.$(".article-header"),i=n.offset().top+n.height();$(window).scroll(_.throttle(function(){$(window).scrollTop()>=i?(t.addClass("affix"),Ibles.Events.trigger("fixHeaderShown",{headerHeight:50})):(t.removeClass("affix"),e.$(".more-menu").hide(),Ibles.Events.trigger("fixHeaderHidden"))},250))}}),Ibles.package("Ibles.views"),Ibles.views.StickyHeader=Ibles.views.StickyHeaderBase.fullExtend({template:_.template(Ibles.JST["sticky-header-desktop"]),events:{"click .flag-menu-btn":"toggleFlagMenu","click .flag-btn":"attemptFlag","click .edit-btn":"editBtnClicked","click .share-menu-btn":"toggleShareMenu","click .more-menu-btn":"toggleMoreMenu","click .add-to-collection-btn":"showAddToCollectionModal","click .add-to-contest-btn":"showAddToContestModal"},initialize:function(){this._super(),this.menu=new Ibles.views.HamburgerMenu({el:"#hamburger-menu",async:!0})},hide:function(){var e=this;setTimeout(function(){e.$(".sticky-header").removeClass("affix")},250)},editBtnClicked:function(){window.location=this.model.getEditUrl()},toggleShareMenu:function(e){this.toggleDropdownMenu(e,$(".share-menu-btn"),$(".share-menu"))},toggleMoreMenu:function(e){this.toggleDropdownMenu(e,$(".more-menu-btn"),$(".more-menu"))},toggleDropdownMenu:function(e,s,o){o.is(":visible")?(o.hide(),$(document).off("click.outside-menu")):(o.show(),setTimeout(function(){$(document).on("click.outside-menu",function(e){var t=$(e.target),n=t.is(s),i=!!t.closest(".dropdown").length;n||i||($(document).off("click.outside-menu"),o.hide())})}))},toggleFlagMenu:function(){Ibles.requireLogin(function(){this.$(".flag-menu").toggle()},{sourcea:"flag"})},attemptFlag:function(e){e.preventDefault();var t=this.model,n=$(e.target),i=n.text(),s=n.attr("data-as");new Ibles.views.ConfirmationView({model:new Ibles.models.ConfirmationModel({confirmationMessage:Ibles.T(Ibles.text.messages.confirmFlag.replace("<< reason >>",i))}),callbackFn:function(){t.set("flaggedAs",s),t.flagAction().success(Ibles.views.AlertView.callbackFactory("success")).error(Ibles.views.AlertView.callbackFactory("error"))}})},showAddToCollectionModal:function(){var e=this;this.$(".more-menu").hide(),Ibles.requireLogin(function(){Ibles.loadJsBundle("create_collection_js",$.proxy(e.renderAddToCollectionModal,e))},{sourcea:"showAddToCollectionModal"})},renderAddToCollectionModal:function(){var e,t;this.addToCollectionView||((e=$(".add-to-collection-btn")).addClass("loading"),t=Ibles.pageContext.ibleData,this.addToCollectionView=new Ibles.views.AddToCollectionView({ibleId:t.id,ibleTitle:t.title,coverImage:t.coverImage}),this.listenToOnce(this.addToCollectionView,"ready",function(){e.removeClass("loading")})),this.addToCollectionView.render()},showAddToContestModal:function(){this.addToContestView||(this.addToContestView=new Ibles.views.AddToContestView({ibleData:Ibles.pageContext.ibleData})),this.addToContestView.render()}}),function(){var e=Ibles.pageContext.ibleData;e&&window.LogHit&&window.LogHit(e.id,"Step by Step"===e.type?"E":"O",e.author.id)}(),Ibles.package("Ibles.views"),Ibles.views.BaseInstructableView=Backbone.View.extend({events:{"click .favorite-btn":"attemptFave","click .follow-btn":"attemptFollow","click .download-pdf, .pdf-btn":"downloadPDF","click .facebook-share-button, .fb-btn":"shareOnFacebook","click .pinterest-share-button, .pin-btn":"shareOnPinterest","click .twittr-share-button, .twit-btn":"shareOnTwitter","click .google-classroom-btn":"shareOnGoogleClassroom"},initialize:function(e){this.opts=_.clone(e||{}),this.renderPostedDate(),this.setUpCategoryTracking(),this.updateFollowingState(),this.updateFavoriteState(),this.listenTo(this.model,"change:favorite",this.updateFavoriteState),this.listenTo(this.model.author,"change:following",this.updateFollowingState),this.listenTo(this.model,"change:favorites change:views",this.updateStats)},renderPostedDate:function(){var e,t;Ibles.session.authenticated()&&(e=moment(this.model.get("publishDate")),t="Unpublished",this.model.get("isPreview")||(t="Published "+e.format("MMM Do, YYYY")),this.$(".posted-date").text(" "+t).show())},downloadPDF:function(){Ibles.featureFlagEnabled("zippable_project")?this.downloadZipBundle():this.downloadPdfOnly()},downloadPdfOnly:function(){Ibles.locationAssign(this.model.getPdfUrl())},downloadZipBundle:function(){var e=this.$(".download-pdf, .pdf-btn").button("loading");this.model.downloadZipBundle().always(function(){e.button("reset")}).fail(function(){alert(Ibles.text.errors.somethingImportantWentWrong)})},attemptFave:function(e){var t=this;e.preventDefault(),Ibles.requireLogin(function(){Ibles.alertWhenError(t.model.favoriteAction())},{sourcea:"favorite"})},attemptFollow:function(e){var t=this;e.preventDefault(),Ibles.requireLogin(function(){Ibles.alertWhenError(t.model.author.toggleFollowing())},{sourcea:"follow"})},updateFavoriteState:function(){var e=$(".favorite-btn"),t=$(".favorite-txt");this.model.get("favorite")?(e.addClass("active"),t.text("Favorited")):(e.removeClass("active"),t.text("Favorite"))},updateFollowingState:function(){var e=this.model.author.get("following");$(".follow-btn").html(e?"Following":"Follow")},updateStats:function(){var e=this.model,t=e.get("favorites"),n=e.get("views");0<t&&this.$(".favorite-count").html(t.toLocaleString()),0<n&&this.$(".view-count").html(n.toLocaleString())},shareOnFacebook:function(e){e.preventDefault(),Ibles.fbShare(this.model.get("fullUrl"))},shareOnPinterest:function(e){e.preventDefault(),window.open("https://www.pinterest.com/pin/create/button/?url={0}&description={1}&media={2}".format(encodeURIComponent(this.model.get("fullUrl")),encodeURIComponent(this.model.get("title")),encodeURIComponent(this.model.get("shareImageUrl"))),"_blank")},shareOnTwitter:function(e){e.preventDefault(),window.open("https://twitter.com/intent/tweet?text={0}&url={1}".format(encodeURIComponent(this.model.get("title")),encodeURIComponent(this.model.get("fullUrl"))),"_blank")},shareOnGoogleClassroom:function(e){e.preventDefault();var t=encodeURIComponent(this.model.get("fullUrl"));window.open("https://classroom.google.com/share?url={0}".format(t),"_blank")},setupSyntaxHighlighting:function(){var i=[];$("pre").each(function(e,t){var n;$(t).attr("data-src")&&""!=$(t).attr("data-src")&&(n=$.ajax({url:$(t).attr("data-src"),type:"GET",success:function(e){$(t).append($("<code></code>").text(e))}}),i.push(n))}),0<i.length&&($("head").append('<link rel="stylesheet" href="'+Ibles.staticUrl("css/prism.css")+'" type="text/css" />'),$.when.apply($,i).always(function(){sessionReady([Ibles.staticUrl("js/libs/prism.js")],function(){Prism.highlightAll(!0)})}))},setUpCategoryTracking:function(){var e={},t={},n=this.model.get("category"),i=this.model.get("channel");if(_.isUndefined(Ibles.getCookie("categoryTimer"))){var s=moment().add(30,"m"),o=Ibles.reverseUrls.ibleUrl(this.model.get("urlString"));Ibles.setCookie("categoryTimer",this.model.get("id"),{path:o,expires:s.toDate()});try{_.isUndefined(localStorage.ibleCategories)||(e=JSON.parse(localStorage.ibleCategories)),_.isUndefined(e[n])?e[n]=1:e[n]=e[n]+1,localStorage.ibleCategories=JSON.stringify(e),_.isUndefined(i)||(_.isUndefined(localStorage.ibleChannels)||(t=JSON.parse(localStorage.ibleChannels)),_.isUndefined(t[i])?t[i]=1:t[i]=t[i]+1,localStorage.ibleChannels=JSON.stringify(t))}catch(e){try{localStorage.clear()}catch(e){}}}},setupAdminPanel:function(){var e,t;!Ibles.isMobile()&&this.model.isEditableByCurrentUser()&&(e=this,(t=$("#admin-container")).length&&Ibles.loadJsBundle("ible_admin_js",function(){e.adminPanel=new Ibles.views.Admin({el:t,model:e.model,collapsible:!0})}))}}),Ibles.package("Ibles.views"),Ibles.views.InstructableView=Ibles.views.BaseInstructableView.fullExtend({events:{"click .license-btn":"showLicense","click .finalized-contests, .contest-entry, .view-btn":"viewContest","click .step-tip":"showTipPoster","click .step-question":"showQuestionPoster","click .step-comment":"showCommentPoster","click .view-comments-btn, .comment-count":"scrollToComments","click .imadeit-btn":"scrollToIMadeIts"},initialize:function(e){this._super(e),this.setupStickyHeader(),this.setupImadeIts(),this.setupComments(),this.listenTo(this.model,"userDataSynced",this.afterUserDataSynced)},afterUserDataSynced:function(){},setupStickyHeader:function(){this.stickyHeader=new Ibles.views.StickyHeader({el:this.$el,model:this.model})},setupImadeIts:function(){this.IMadeItsManager=new Ibles.views.ImadeItsManager({el:"#imadeits",model:this.model})},setupComments:function(){var n=this,e=n.model;e.get("disableComments")||sessionReady(function(){n.commentsManager=new Ibles.views.CommentsManager({el:"#comments",model:e,fetchRatings:!0,additionalCommentContext:function(e){var t=e.get("stepId");return t?n.getStepProps(t):{}}}),n.commentTypeSelector=new Ibles.views.CommentTypeSelector({el:"#discuss",manager:n.commentsManager}).render()})},showLicense:function(){var e=this.$(".license-btn").data("url");window.open(e,"LICENSE","status=yes,scrollbars=yes,resizable=yes,width=800,height=400")},viewContest:function(e){var t=$(e.target).closest(".contest-entry").find("a").attr("href");window.location=t},getTitleForPhotoset:function(e){var t=$(e).prev(".step-title").text();return t.substring(t.indexOf(":")+1).trim()},getStepId:function(e){return $(e.target).closest(".step").data("stepid")},getStepProps:function(e){var t,n=$('.step[data-stepid="'+e+'"]'),i={};return n.length&&(t=n.find(".step-title").text(),_.extend(i,{stepId:e,stepAnchorId:n.attr("id"),stepIndexLabel:t.substring(0,t.indexOf(":")).trim()})),i},showTipPoster:function(e){this.showStepCommentPoster(e,"tip")},showQuestionPoster:function(e){this.showStepCommentPoster(e,"question")},showCommentPoster:function(e){this.showStepCommentPoster(e,"comment")},showStepCommentPoster:function(e,t){var n=this,i=n.commentTypeSelector;i.renderPoster({designation:t,modelProps:{stepId:$(e.target).closest(".step").data("stepid"),designations:[t]},callback:function(){i.scrollToMe(),n.stickyHeader.hide()}})},scrollToComments:function(){window.location.hash="#discuss"},scrollToIMadeIts:function(e){this.IMadeItsManager.renderPoster(e),window.location.hash="#imadeits"}}),Ibles.package("Ibles.views"),Ibles.views.DesktopInstructableView=Ibles.views.InstructableView.fullExtend({events:{"click .view-in-3d-btn":"viewIn3d","click .step-link":"stepLinkClicked"},initialize:function(e){this._super(e),this.setupPhotosets(),this.setupSyntaxHighlighting(),this.showAuthorActions(),this.updateFeaturedBy(),this.updatePublishDate()},afterUserDataSynced:function(){this._super(),this.setupAdminPanel()},setupPhotosets:function(){var i=this;this.model.getPhotosetFiles().done(function(n){var e=i.$(".mediaset");_.each(e,function(e,t){new Ibles.views.PhotosetView({el:e,model:i.model,fileCollection:n[t],title:i.getTitleForPhotoset(e)})})})},isViewedByAuthor:function(){var e=Ibles.session;return e.authenticated()&&e.get("screenName")===this.model.author.get("screenName")},showAuthorActions:function(){var e=Ibles.session,t=e.authenticated()&&e.isAdmin(),n=this.isViewedByAuthor(),i=!_.isEmpty(this.model.get("collaborators"))&&!_.isEmpty(_.findWhere(this.model.get("collaborators"),{screenName:e.get("screenName")}));(t||n||i)&&this.$(".author-action").removeClass("author-action"),t&&this.$(".admin-action").removeClass("admin-action")},updatePublishDate:function(){var e;Ibles.session.authenticated()&&(e=moment(this.model.get("publishDate")).format("MMMM DD YYYY"),this.$(".publish-date").html(e))},updateFeaturedBy:function(){(Ibles.session.isAdmin()||Ibles.session.isStaff())&&(!0!==this.model.get("featureFlag")||_.isUndefined(this.model.get("featuredBy"))||this.$(".featured-by").html(_.template(Ibles.JST["featured-by"])(this.model.toJSON())))},viewIn3d:function(t){t.preventDefault();var e=$($(t.target).attr("data-embed-html"));e.removeAttr("width"),e.removeAttr("height");var n=$("<div></div>");n.append(e),head.load(Ibles.staticUrl("css/embedModal.css")),Ibles.loadJsBundle("ible_modal_embed_viewer_js",function(){var e=new Ibles.views.EmbedModalView({model:new Ibles.models.EmbedModel({embedCode:n.html(),fileName:$(t.target).attr("data-embed-filename")})});$("body").append(e.render())})},stepLinkClicked:function(){this.stickyHeader.hide()}});